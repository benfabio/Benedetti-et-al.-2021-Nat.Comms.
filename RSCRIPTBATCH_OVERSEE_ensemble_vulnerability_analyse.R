
# --------------------------------------------------------------------------------------------------------------------------------

library("tidyverse")
library("RColorBrewer")
library("reshape2")
library("viridis")
library("scales")
library("maps")
library("geosphere")
library("rgdal")
library("raster")

world2 <- map_data("world2")

# --------------------------------------------------------------------------------------------------------------------------------

### Set the working directories, vectors etc.
WD <- getwd()
rcp <- "rcp85"
# Vectors
SDMs <- c('GAM','GLM','RF','ANN')
# Vector of months
months <- c("jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec")
# Vector of pools
pools <- c("p1","p2","p3","p4")
# Vector of earth system models
ESMs <- c("CESM-BEC","CNRM-PISCES","GFDL-TOPAZ","IPSL-PISCES","MRI-NEMURO")

# --------------------------------------------------------------------------------------------------------------------------------

### 1°) Get ensemble predictions of changes in phyto and zoo richness and composition
setwd("/net/kryo/work/fabioben/OVERSEE/data/tables_composition_ensemble_rcp85/Individual_projections")
files <- dir()[grep("table_ann_changes_",dir())]; files
# Separate the ones for richness (no "beta.div") from those with beta.div
files2 <- files[grep("beta.div", files)]; files2
files1 <- files[!(files %in% files2)]; files1

require("parallel")
res <- mclapply(files1, function(f) {
            # Useless message
            message(paste("Loading results from ",f, sep = ""))
            t <- get(load(f))
            # Get attributes from filename
            terms <- do.call(cbind, strsplit(as.character(f),"_"))
            t$ESM <- terms[4,1] 
            t$SDM <- terms[5,1] 
            p <- terms[6,1]
            t$pool <- str_replace(as.character(p),".Rdata","")
            # Return
            return(t)
    }, mc.cores = 25
) # eo mclapply
table <- dplyr::bind_rows(res)
head(table);dim(table)
rm(res); gc()

### Computing ensembles (all, SDM/ESM/pool)
ens <- data.frame(table %>%
        group_by(id) %>%
        summarize(x = unique(x), y = unique(y), 
            rich_tot = mean(perc_rich_tot, na.rm = T), sd_rich_tot = sd(perc_rich_tot, na.rm = T),
            rich_phyto = mean(perc_rich_phyto, na.rm = T), sd_rich_phyto = sd(perc_rich_phyto, na.rm = T),
            rich_zoo = mean(perc_rich_zoo, na.rm = T), sd_rich_zoo = sd(perc_rich_zoo, na.rm = T)
        ) 
) # ddf
summary(ens)

setwd("/net/hydro/work/fabioben/OVERSEE/data/tables_composition_ensemble_rcp85/Individual_projections")
require("parallel")
# f <- files2[1]
res <- mclapply(files2, function(f) {
            # Useless message
            message(paste("Loading results from ",f, sep = ""))
            t <- get(load(f))
            # Get attributes from filename
            terms <- do.call(cbind, strsplit(as.character(f),"_"))
            t$ESM <- terms[6,1] 
            t$SDM <- terms[7,1] 
            p <- terms[8,1]
            t$pool <- str_replace(as.character(p),".Rdata","")
            # Return
            return(t)
    }, mc.cores = 25
) # eo mclapply
# Rbind
table <- dplyr::bind_rows(res)
head(table); dim(table)
rm(res); gc()
# unique(table$jac)
colnames(table)
summary(table)

### Computing ensembles (all, SDM/ESM/pool)
ens2 <- data.frame(table %>%
        group_by(id) %>%
        summarize(x = unique(x), y = unique(y), 
            jac = mean(jac, na.rm = T),
            jne = mean(jne, na.rm = T),
            jtu = mean(jtu, na.rm = T),
            jac_phyto = mean(jac_phyto, na.rm = T),
            jne_phyto = mean(jne_phyto, na.rm = T),
            jtu_phyto = mean(jtu_phyto, na.rm = T),
            jac_zoo = mean(jac_zoo, na.rm = T),
            jne_zoo = mean(jne_zoo, na.rm = T),
            jtu_zoo = mean(jtu_zoo, na.rm = T)
        ) 
) # ddf
summary(ens2)

# ### Draw zonal patterns
# zonal <- data.frame(ens2 %>%
#             group_by(y) %>%
#             summarise(jtu.plankton = mean(jtu, na.rm=T), jtu.sd = sd(jtu, na.rm=T),
#             jtu.phyto = mean(jtu_phyto, na.rm=T),jtu.phyto.sd = sd(jtu_phyto, na.rm=T),
#             jtu.zoo = mean(jtu_zoo, na.rm=T), jtu.zoo.sd = sd(jtu_zoo, na.rm=T) )
# ) # eo ddf
# summary(zonal)
#
# # Define maxi and mins
# min <- 0
# max <- 0.65
# #
# plot1 <- ggplot() + geom_ribbon(aes(x = y, ymin = jtu.plankton - jtu.sd, ymax = jtu.plankton + jtu.sd), fill = "grey70", data = zonal) +
#    geom_line(aes(x = y, y = jtu.plankton), data = zonal, colour = "black" ) + scale_y_continuous(limits = c(min,max)) +
#    ylab("Mean annual turn-over\n(Plankton)") + xlab("Latitude (°)") + theme_classic() + coord_flip()
#
# plot2 <- ggplot() + geom_ribbon(aes(x = y, ymin = jtu.phyto - jtu.phyto.sd, ymax = jtu.phyto + jtu.phyto.sd), fill = "grey70", data = zonal) +
#    geom_line(aes(x = y, y = jtu.phyto), data = zonal, colour = "black" ) + scale_y_continuous(limits = c(min,max)) +
#    ylab("Mean annual turn-over\n(Phytoplankton)") + xlab("Latitude (°)") + theme_classic() + coord_flip()
# #
# plot3 <- ggplot() + geom_ribbon(aes(x = y, ymin = jtu.zoo - jtu.zoo.sd, ymax = jtu.zoo + jtu.zoo.sd), fill = "grey70", data = zonal) +
#    geom_line(aes(x = y, y = jtu.zoo), data = zonal, colour = "black" ) + scale_y_continuous(limits = c(min,max)) +
#    ylab("Mean annual turn-over\n(Zooplankton)") + xlab("Latitude (°)") + theme_classic() + coord_flip()
# #
# setwd(WD)
# ggsave(plot = plot1, filename = "plot_zonal_ann_plankton_jtu_ensemble.jpg", dpi = 300, width = 3, height = 4)
# ggsave(plot = plot2, filename = "plot_zonal_ann_phyto_jtu_ensemble.jpg", dpi = 300, width = 3, height = 4)
# ggsave(plot = plot3, filename = "plot_zonal_ann_zoo_jtu_ensemble.jpg", dpi = 300, width = 3, height = 4)

### Merge with changes in richness
colnames(ens); colnames(ens2); dim(ens) ; dim(ens2)
ens <- ens[order(ens$id),]
ens2 <- ens2[order(ens2$id),]
# Find common celss
commons <- intersect(unique(ens$id), unique(ens2$id))
length(commons)
ens <- ens[which(ens$id %in% commons),]
ens2 <- ens2[which(ens2$id %in% commons),]

changes <- data.frame(id = ens$id, x = ens$x, y = ens$y,
        rich_phyto = ens$rich_phyto, rich_zoo = ens$rich_zoo,
        jac = ens2$jac, jtu_phyto = ens2$jtu_phyto, jtu_zoo = ens2$jtu_zoo
) # eo ddf
summary(changes) ; dim(changes)


### --------------------------------------------------------------------------------

### 2°) Use k-means clustering post-PCA to ordinate ocean cells according to their models of diversity changes
require("FactoMineR")
require("vegan")
require("cluster")
require("FD") 
require("fpc") 

strategies <- c("PCA+Euclid+PAM","Euclid+PAM","Mahal+PAM","PCA+Euclid+Ward","PCA+Euclid+Avg","PCA+Euclid+Complete","Mahal+Ward","Mahal+Avg","Mahal+Complete")

impacts <- na.omit(changes)
# For testing
# bas <- "impacts"
# strat <- "PCA+Euclid+Avg"
cluster.tester <- function(bas, strat) {
        
        message(paste("", sep = ""))
        message(paste("Evaluating clusters based on ",bas," using ",strat, sep = ""))
        message(paste("", sep = ""))
        
        ### Choose data table as a function of "basis"
        if(bas == "impacts") {
            data <- impacts
        } else if(bas == "services") {
            data <- services
        } # eo if else
    
        ### Perform clustering as a function of "strat"
       if(strat == "PCA+Euclid+PAM") {
            
                # Perform PCA first, retrieve scores and display % var explained along first 4 ncp
                message(paste("Computing PCA and Euclidean distance matrix", sep = ""))
                pca <- PCA(X = data[,c(4:length(data))], graph = F, scale.unit = T)
                # Display summary
                message(paste(summary(pca),sep = ""))
                coords <- pca$ind$coord[,c(1:4)]
                # Compute euclidean dist matrix
                dist <- dist(coords,"euclidean") 
            
                # perform PAM for several k values (2->10)
                message(paste("Generating clusters and analyzing their robustness", sep = ""))
                scores <- function(k) {
                          km <- pam(dist, k = k, diss = T, keep.diss = F, do.swap = FALSE)
                          ss <- silhouette(km$cluster, dist)
                          ch <- calinhara(x = data[,c(4:length(data))], clustering = km$cluster, cn = k)
                          data.frame(kval = k, mean = mean(ss[,3]), sd = sd(ss[,3]), CHI = ch)
                } # eo FUN
                k <- c(2:10)
                avg_silh <- lapply(k,scores)
                # Convert to ddf for ggploting
                ddf_silh <- bind_rows(avg_silh)
                # Plot silhouette profile
                plot <- ggplot() + geom_errorbar(aes(x = factor(kval), ymin = mean-sd, ymax = mean+sd), data = ddf_silh, width = 0.25) + 
                        geom_path(aes(x = factor(kval), y = mean), linetype = "dashed", data = ddf_silh, group=1) + 
                        geom_point(aes(x = factor(kval), y = mean), pch = 21, colour = "black", fill = "#de77ae", data = ddf_silh) + 
                        scale_y_continuous(limits = c(0,1)) + 
                        xlab("Number of clusters (k)") + ylab("Mean silhouette width") +
                        theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                message(paste("Printing silhouette plot for clusters based ",bas," + ",strat, sep = ""))
                ggsave(plot = plot, filename = paste("plot_silh_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
             
                plot2 <- ggplot() + geom_path(aes(x = factor(kval), y = CHI), linetype = "dashed", data = ddf_silh, group=1) + 
                         geom_point(aes(x = factor(kval), y = CHI), pch = 21, colour = "black", fill = "#b8e186", data = ddf_silh) + 
                         xlab("Number of clusters (k)") + ylab("Calinski-Harabasz index") +
                         theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                ggsave(plot = plot2, filename = paste("plot_CHI_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
            
        } else if(strat == "Euclid+PAM") {
            
                message(paste("Computing Euclidean distance matrix", sep = ""))
                dist <- dist(data[,c(4:length(data))],"euclidean")
            
                # perform PAM for several k values (2->10)
                message(paste("Generating clusters and analyzing their robustness", sep = ""))
                scores <- function(k) {
                          km <- pam(dist, k = k, diss = T, keep.diss = F, do.swap = FALSE)
                          ss <- silhouette(km$cluster, dist)
                          ch <- calinhara(x = data[,c(4:length(data))], clustering = km$cluster, cn = k)
                          data.frame(kval = k, mean = mean(ss[,3]), sd = sd(ss[,3]), CHI = ch)
                } # eo FUN
                k <- c(2:10)
                avg_silh <- lapply(k,scores) # str(avg_silh)
                # Convert to ddf for ggploting
                ddf_silh <- bind_rows(avg_silh)
                # Plot silhouette profile
                plot <- ggplot() + geom_errorbar(aes(x = factor(kval), ymin = mean-sd, ymax = mean+sd), data = ddf_silh, width = 0.25) + 
                        geom_path(aes(x = factor(kval), y = mean), linetype = "dashed", data = ddf_silh, group=1) + 
                        geom_point(aes(x = factor(kval), y = mean), pch = 21, colour = "black", fill = "#de77ae", data = ddf_silh) + 
                        scale_y_continuous(limits = c(0,1)) + 
                        xlab("Number of clusters (k)") + ylab("Mean silhouette width") +
                        theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                message(paste("Printing silhouette plot for clusters based ",bas," + ",strat, sep = ""))
                ggsave(plot = plot, filename = paste("plot_silh_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
             
                plot2 <- ggplot() + geom_path(aes(x = factor(kval), y = CHI), linetype = "dashed", data = ddf_silh, group=1) + 
                         geom_point(aes(x = factor(kval), y = CHI), pch = 21, colour = "black", fill = "#b8e186", data = ddf_silh) + 
                         xlab("Number of clusters (k)") + ylab("Calinski-Harabasz index") +
                         theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                ggsave(plot = plot2, filename = paste("plot_CHI_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
               
         } else if(strat == "Mahal+PAM") {
            
                 message(paste("Computing Mahalanobis distance matrix", sep = ""))
                 dist <- FD::mahaldis( as.matrix(data[,c(4:length(data))]) )
            
                 # perform PAM for several k values (2->10)
                 message(paste("Generating clusters and analyzing their robustness", sep = ""))
                 scores <- function(k) {
                       km <- pam(dist, k = k, diss = T, keep.diss = F, do.swap = FALSE)
                       ss <- silhouette(km$cluster, dist)
                       ch <- calinhara(x = data[,c(4:length(data))], clustering = km$cluster, cn = k)
                       data.frame(kval = k, mean = mean(ss[,3]), sd = sd(ss[,3]), CHI = ch)
                  } # eo FUN
                  k <- c(2:10)
                  avg_silh <- lapply(k,scores) # str(avg_silh)
                  # Convert to ddf for ggploting
                  ddf_silh <- bind_rows(avg_silh)
                  # Plot silhouette profile
                  plot <- ggplot() + geom_errorbar(aes(x = factor(kval), ymin = mean-sd, ymax = mean+sd), data = ddf_silh, width = 0.25) + 
                         geom_path(aes(x = factor(kval), y = mean), linetype = "dashed", data = ddf_silh, group=1) + 
                         geom_point(aes(x = factor(kval), y = mean), pch = 21, colour = "black", fill = "#de77ae", data = ddf_silh) + 
                         scale_y_continuous(limits = c(0,1)) + 
                         xlab("Number of clusters (k)") + ylab("Mean silhouette width") +
                         theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                  message(paste("Printing silhouette plot for clusters based ",bas," + ",strat, sep = ""))
                  ggsave(plot = plot, filename = paste("plot_silh_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
       
                  plot2 <- ggplot() + geom_path(aes(x = factor(kval), y = CHI), linetype = "dashed", data = ddf_silh, group=1) + 
                          geom_point(aes(x = factor(kval), y = CHI), pch = 21, colour = "black", fill = "#b8e186", data = ddf_silh) + 
                          xlab("Number of clusters (k)") + ylab("Calinski-Harabasz index") +
                          theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                  ggsave(plot = plot2, filename = paste("plot_CHI_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
        
        } else if(strat == "PCA+Euclid+Ward") {
       
                # Perform PCA first, retrieve scores and display % var explained along first 4 ncp
                message(paste("Computing PCA + Euclidean distance matrix + Ward's link", sep = ""))
                pca <- PCA(X = data[,c(4:length(data))], graph = F, scale.unit = T)
                # Display summary
                message(paste(summary(pca),sep = ""))
                coords <- pca$ind$coord[,c(1:4)]
                # Compute euclidean dist matrix
                dist <- dist(coords,"euclidean") 
                # Derive dendrogram using Ward's aggergation link
                clust <- hclust(dist,"ward.D2")
            
                # perform PAM for several k values (2->10)
                message(paste("Generating clusters and analyzing their robustness", sep = ""))
                scores <- function(k) {
                      km <- cutree(clust, k)
                      ss <- silhouette(km, dist)
                      ch <- calinhara(x = data[,c(4:length(data))], clustering = km, cn = k)
                      data.frame(kval = k, mean = mean(ss[,3]), sd = sd(ss[,3]), CHI = ch)
                } # eo FUN
                k <- c(2:10)
                avg_silh <- lapply(k,scores) 
                ddf_silh <- bind_rows(avg_silh)
                # Plot silhouette profile
                plot <- ggplot() + geom_errorbar(aes(x = factor(kval), ymin = mean-sd, ymax = mean+sd), data = ddf_silh, width = 0.25) + 
                            geom_path(aes(x = factor(kval), y = mean), linetype = "dashed", data = ddf_silh, group=1) + 
                            geom_point(aes(x = factor(kval), y = mean), pch = 21, colour = "black", fill = "#de77ae", data = ddf_silh) + 
                            scale_y_continuous(limits = c(0,1)) + 
                            xlab("Number of clusters (k)") + ylab("Mean silhouette width") +
                            theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                message(paste("Printing silhouette plot for clusters based ",bas," + ",strat, sep = ""))
                ggsave(plot = plot, filename = paste("plot_silh_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
             
                plot2 <- ggplot() + geom_path(aes(x = factor(kval), y = CHI), linetype = "dashed", data = ddf_silh, group=1) + 
                         geom_point(aes(x = factor(kval), y = CHI), pch = 21, colour = "black", fill = "#b8e186", data = ddf_silh) + 
                         xlab("Number of clusters (k)") + ylab("Calinski-Harabasz index") +
                         theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                ggsave(plot = plot2, filename = paste("plot_CHI_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
       
        } else if(strat == "PCA+Euclid+Avg") {
            
                # Perform PCA first, retrieve scores and display % var explained along first 4 ncp
                message(paste("Computing PCA + Euclidean distance matrix + Average link", sep = ""))
                pca <- PCA(X = data[,c(4:length(data))], graph = F, scale.unit = T)
                # Display summary
                message(paste(summary(pca),sep = ""))
                coords <- pca$ind$coord[,c(1:4)]
                # Compute euclidean dist matrix
                dist <- dist(coords,"euclidean") 
                # Derive dendrogram using Ward's aggregation link
                clust <- hclust(dist,"average")
            
                # perform PAM for several k values (2->10)
                message(paste("Generating clusters and analyzing their robustness", sep = ""))
                scores <- function(k) {
                          km <- cutree(clust, k)
                          ss <- silhouette(km, dist)
                          ch <- calinhara(x = data[,c(4:length(data))], clustering = km, cn = k)
                          data.frame(kval = k, mean = mean(ss[,3]), sd = sd(ss[,3]), CHI = ch)
                } # eo FUN
                k <- c(2:10)
                avg_silh <- lapply(k,scores) 
                ddf_silh <- bind_rows(avg_silh)
                # Plot silhouette profile
                plot <- ggplot() + geom_errorbar(aes(x = factor(kval), ymin = mean-sd, ymax = mean+sd), data = ddf_silh, width = 0.25) + 
                            geom_path(aes(x = factor(kval), y = mean), linetype = "dashed", data = ddf_silh, group=1) + 
                            geom_point(aes(x = factor(kval), y = mean), pch = 21, colour = "black", fill = "#de77ae", data = ddf_silh) + 
                            scale_y_continuous(limits = c(0,1)) + 
                            xlab("Number of clusters (k)") + ylab("Mean silhouette width") +
                            theme_classic() + ggtitle(paste(strat," based on ",bas, sep = ""))
            
                message(paste("Printing silhouette plot for clusters based ",bas," + ",strat, sep = ""))
                ggsave(plot = plot, filename = paste("plot_silh_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
             
                plot2 <- ggplot() + geom_path(aes(x = factor(kval), y = CHI), linetype = "dashed", data = ddf_silh, group=1) + 
                             geom_point(aes(x = factor(kval), y = CHI), pch = 21, colour = "black", fill = "#b8e186", data = ddf_silh) + 
                             xlab("Number of clusters (k)") + ylab("Calinski-Harabasz index") +
                             theme_classic() + ggtitle(paste(strat," based on ",bas, sep = ""))
            
                ggsave(plot = plot2, filename = paste("plot_CHI_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
         
         } else if(strat == "PCA+Euclid+Complete") {
            
                 # Perform PCA first, retrieve scores and display % var explained along first 4 ncp
                 message(paste("Computing PCA + Euclidean distance matrix + Complete linkage", sep = ""))
                 pca <- PCA(X = data[,c(4:length(data))], graph = F, scale.unit = T)
                 # Display summary
                 message(paste(summary(pca),sep = ""))
                 coords <- pca$ind$coord[,c(1:4)]
                 # Compute euclidean dist matrix
                 dist <- dist(coords,"euclidean") 
                 # Derive dendrogram using Ward's aggregation link
                 clust <- hclust(dist,"complete")
                 # perform PAM for several k values (2->10)
                 message(paste("Generating clusters and analyzing their robustness", sep = ""))
                 scores <- function(k) {
                           km <- cutree(clust, k)
                           ss <- silhouette(km, dist)
                           ch <- calinhara(x = data[,c(4:length(data))], clustering = km, cn = k)
                           data.frame(kval = k, mean = mean(ss[,3]), sd = sd(ss[,3]), CHI = ch)
                 } # eo FUN
                 k <- c(2:10)
                 avg_silh <- lapply(k,scores) 
                 ddf_silh <- bind_rows(avg_silh)
                 # Plot silhouette profile
                 plot <- ggplot() + geom_errorbar(aes(x = factor(kval), ymin = mean-sd, ymax = mean+sd), data = ddf_silh, width = 0.25) + 
                             geom_path(aes(x = factor(kval), y = mean), linetype = "dashed", data = ddf_silh, group=1) + 
                             geom_point(aes(x = factor(kval), y = mean), pch = 21, colour = "black", fill = "#de77ae", data = ddf_silh) + 
                             scale_y_continuous(limits = c(0,1)) + 
                             xlab("Number of clusters (k)") + ylab("Mean silhouette width") +
                             theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                 message(paste("Printing silhouette plot for clusters based ",bas," + ",strat, sep = ""))
                 ggsave(plot = plot, filename = paste("plot_silh_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
             
                  plot2 <- ggplot() + geom_path(aes(x = factor(kval), y = CHI), linetype = "dashed", data = ddf_silh, group=1) + 
                          geom_point(aes(x = factor(kval), y = CHI), pch = 21, colour = "black", fill = "#b8e186", data = ddf_silh) + 
                          xlab("Number of clusters (k)") + ylab("Calinski-Harabasz index") +
                          theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                  ggsave(plot = plot2, filename = paste("plot_CHI_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
                 
        } else if(strat == "Mahal+Avg") {
       
                message(paste("Computing Mahalanobis distance matrix + Average link", sep = ""))
                dist <- FD::mahaldis(as.matrix(data[,c(4:length(data))]))
                # Derive dendrogram using Ward's aggregation link
                clust <- hclust(dist,"average")
                message(paste("Generating clusters and analyzing their robustness", sep = ""))
                scores <- function(k) {
                          km <- cutree(clust, k)
                          ss <- silhouette(km, dist)
                          ch <- calinhara(x = data[,c(4:length(data))], clustering = km, cn = k)
                          data.frame(kval = k, mean = mean(ss[,3]), sd = sd(ss[,3]), CHI = ch)
                } # eo FUN
                k <- c(2:10)
                avg_silh <- lapply(k,scores) 
                ddf_silh <- bind_rows(avg_silh)
                # Plot silhouette profile
                plot <- ggplot() + geom_errorbar(aes(x = factor(kval), ymin = mean-sd, ymax = mean+sd), data = ddf_silh, width = 0.25) + 
                            geom_path(aes(x = factor(kval), y = mean), linetype = "dashed", data = ddf_silh, group=1) + 
                            geom_point(aes(x = factor(kval), y = mean), pch = 21, colour = "black", fill = "#de77ae", data = ddf_silh) + 
                            scale_y_continuous(limits = c(0,1)) + 
                            xlab("Number of clusters (k)") + ylab("Mean silhouette width") +
                            theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                message(paste("Printing silhouette plot for clusters based ",bas," + ",strat, sep = ""))
                ggsave(plot = plot, filename = paste("plot_silh_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
             
                plot2 <- ggplot() + geom_path(aes(x = factor(kval), y = CHI), linetype = "dashed", data = ddf_silh, group=1) + 
                         geom_point(aes(x = factor(kval), y = CHI), pch = 21, colour = "black", fill = "#b8e186", data = ddf_silh) + 
                         xlab("Number of clusters (k)") + ylab("Calinski-Harabasz index") +
                         theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                ggsave(plot = plot2, filename = paste("plot_CHI_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
          
        } else if(strat == "Mahal+Ward") {
       
                message(paste("Computing Mahalanobis distance matrix + Ward's link", sep = ""))
                dist <- FD::mahaldis( as.matrix(data[,c(4:length(data))]) )
                # Derive dendrogram using Ward's aggregation link
                clust <- hclust(dist,"ward.D2")
                message(paste("Generating clusters and analyzing their robustness", sep = ""))
                scores <- function(k) {
                          km <- cutree(clust, k)
                          ss <- silhouette(km, dist)
                          ch <- calinhara(x = data[,c(4:length(data))], clustering = km, cn = k)
                          data.frame(kval = k, mean = mean(ss[,3]), sd = sd(ss[,3]), CHI = ch)
                } # eo FUN
                k <- c(2:10)
                avg_silh <- lapply(k,scores) 
                ddf_silh <- bind_rows(avg_silh)
                # Plot silhouette profile
                plot <- ggplot() + geom_errorbar(aes(x = factor(kval), ymin = mean-sd, ymax = mean+sd), data = ddf_silh, width = 0.25) + 
                            geom_path(aes(x = factor(kval), y = mean), linetype = "dashed", data = ddf_silh, group=1) + 
                            geom_point(aes(x = factor(kval), y = mean), pch = 21, colour = "black", fill = "#de77ae", data = ddf_silh) + 
                            scale_y_continuous(limits = c(0,1)) + 
                            xlab("Number of clusters (k)") + ylab("Mean silhouette width") +
                            theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                message(paste("Printing silhouette plot for clusters based ",bas," + ",strat, sep = ""))
                ggsave(plot = plot, filename = paste("plot_silh_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
            
                plot2 <- ggplot() + geom_path(aes(x = factor(kval), y = CHI), linetype = "dashed", data = ddf_silh, group=1) + 
                         geom_point(aes(x = factor(kval), y = CHI), pch = 21, colour = "black", fill = "#b8e186", data = ddf_silh) + 
                         xlab("Number of clusters (k)") + ylab("Calinski-Harabasz index") +
                         theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                ggsave(plot = plot2, filename = paste("plot_CHI_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
            
         } else if(strat == "Mahal+Complete") {
       
                 message(paste("Computing Mahalanobis distance matrix + Complete linkage", sep = ""))
                 dist <- FD::mahaldis(as.matrix(data[,c(4:length(data))]))
                 # Derive dendrogram using Ward's aggregation link
                 clust <- hclust(dist,"complete")
                 # Cut the dendrogram at several k levels and assess silhouette plot
                 message(paste("Generating clusters and analyzing their robustness", sep = ""))
                 scores <- function(k) {
                           km <- cutree(clust, k)
                           ss <- silhouette(km, dist)
                           ch <- calinhara(x = data[,c(4:length(data))], clustering = km, cn = k)
                           data.frame(kval = k, mean = mean(ss[,3]), sd = sd(ss[,3]), CHI = ch)
                  } # eo FUN
                  k <- c(2:10)
                  avg_silh <- lapply(k,scores) 
                  ddf_silh <- bind_rows(avg_silh)
                  # Plot silhouette profile
                  plot <- ggplot() + geom_errorbar(aes(x = factor(kval), ymin = mean-sd, ymax = mean+sd), data = ddf_silh, width = 0.25) + 
                             geom_path(aes(x = factor(kval), y = mean), linetype = "dashed", data = ddf_silh, group=1) + 
                             geom_point(aes(x = factor(kval), y = mean), pch = 21, colour = "black", fill = "#de77ae", data = ddf_silh) + 
                             scale_y_continuous(limits = c(0,1)) + 
                             xlab("Number of clusters (k)") + ylab("Mean silhouette width") +
                             theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                  message(paste("Printing silhouette plot for clusters based ",bas," + ",strat, sep = ""))
                  ggsave(plot = plot, filename = paste("plot_silh_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
             
                  plot2 <- ggplot() + geom_path(aes(x = factor(kval), y = CHI), linetype = "dashed", data = ddf_silh, group=1) + 
                              geom_point(aes(x = factor(kval), y = CHI), pch = 21, colour = "black", fill = "#b8e186", data = ddf_silh) + 
                              xlab("Number of clusters (k)") + ylab("Calinski-Harabasz index") +
                              theme_classic() + ggtitle(paste(strat," based on ",bas, sep= ""))
            
                  ggsave(plot = plot2, filename = paste("plot_CHI_",strat,"_",bas,".png", sep = ""), dpi = 300, width = 6, height = 3)	
          
        } # eo if else loop
    
} # eo FUN

# Test function above
cluster.tester("impacts", "Mahal+Complete")

### If it works, apply function in parallel with mclapply() ! (one basis, all 9 strats)
require("parallel")
mclapply(X = strategies, FUN = cluster.tester, mc.cores = 15, bas = "impacts")

### Ok, now use the test above to guide your choice of method and n clusters 
## Based on impact metrics:
# - PCA+Euclid+PAM --> 5/6
# - PCA+Euclid+Ward --> 4/5
# - PCA+Euclid+Avg --> 5
# - PCA+Euclid+Complete --> 5
# - Euclid+PAM --> 4/5
# - Mahal+PAM --> 3/5
# - Mahal+Ward --> 4/5
# - Mahal+Avg --> 5
# - Mahal+Complete --> 5

### Make maps our of these using the same strategy
cluster.mapper <- function(bas, strat) {
        
        message(paste("", sep = ""))
        message(paste("Mapping clusters based on ",bas," using ",strat, sep = ""))
        message(paste("", sep = ""))
        
        ### Choose data table as a function of "basis"
        if(bas == "impacts") {
            
            data <- impacts
            
        } else if(bas == "services") {
            
            data <- services
            
        } # eo if else
    
       ### Perform clustering as a function of "strat"
        if(strat == "PCA+Euclid+PAM") {
            
                # Perform PCA first, retrieve scores and display % var explained along first 4 ncp
                message(paste("Computing PCA and Euclidean distance matrix", sep = ""))
                pca <- PCA(X = data[,c(4:length(data))], graph = F, scale.unit = T)
                # Display summary
                message(paste(summary(pca),sep = ""))
                coords <- pca$ind$coord[,c(1:4)]
                # Compute euclidean dist matrix
                dist <- dist(coords,"euclidean") 
                k <- 5
                km <- pam(dist, k = k, diss = T, keep.diss = F, do.swap = F)
                data$k <- km$cluster
            
                message(paste("Mapping the ",k," clusters", sep = ""))
                map <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(k)), data = data) +
                 	scale_fill_manual(name = "Clusters", values = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c")) +
                 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
                 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
                 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
                 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
                   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
                 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
                
                ggsave(plot = map, filename = paste("map_clusters_",bas,"_",strat,"_",k,".png", sep = ""), dpi = 300, width = 7, height = 5)	
                
                ### And k = 6
                k <- 6
                km <- pam(dist, k = k, diss = T, keep.diss = F, do.swap = F)
                data$k <- km$cluster
            
                message(paste("Mapping the ",k," clusters", sep = ""))
                map <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(k)), data = data) +
                 	scale_fill_manual(name = "Clusters", values = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c")) +
                 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
                 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
                 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
                 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
                   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
                 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
                
                ggsave(plot = map, filename = paste("map_clusters_",bas,"_",strat,"_",k,".png", sep = ""), dpi = 300, width = 7, height = 5)	
          
            
        } else if(strat == "Euclid+PAM") {
       
                message(paste("Computing Euclidean distance matrix", sep = ""))
                dist <- dist(data[,c(4:length(data))],"euclidean")
                
                # perform PAM for several k values (2->10)
                k <- 4
                km <- pam(dist, k = k, diss = T, keep.diss = F, do.swap = FALSE) 
                data$k <- km$cluster
                message(paste("Mapping the ",k," clusters", sep = ""))
                map <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(k)), data = data) +
                 	scale_fill_manual(name = "Clusters", values = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c") ) +
                 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
                 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
                 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
                 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
                   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
                 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
                
                ggsave(plot = map, filename = paste("map_clusters_",bas,"_",strat,"_",k,".png", sep = ""), dpi = 300, width = 7, height = 5)
                
                ### And with k = 5
                k <- 5
                km <- pam(dist, k = k, diss = T, keep.diss = F, do.swap = FALSE) 
                data$k <- km$cluster
                message(paste("Mapping the ",k," clusters", sep = ""))
                map <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(k)), data = data) +
                 	scale_fill_manual(name = "Clusters", values = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c")) +
                 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
                 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
                 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
                 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
                   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
                 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
                
                ggsave(plot = map, filename = paste("map_clusters_",bas,"_",strat,"_",k,".png", sep = ""), dpi = 300, width = 7, height = 5)	
     
                      
        } else if(strat == "PCA+Euclid+Avg") {
            
                # Perform PCA first, retrieve scores and display % var explained along first 4 ncp
                message(paste("Computing PCA + Euclidean distance matrix + Average link", sep = ""))
                pca <- PCA(X = data[,c(4:length(data))], graph = F, scale.unit = T)
                # Display summary
                message(paste(summary(pca),sep = ""))
                coords <- pca$ind$coord[,c(1:4)]
                # Compute euclidean dist matrix
                dist <- dist(coords,"euclidean") 
                # Derive dendrogram using Ward's aggregation link
                clust <- hclust(dist,"average")
                data$k1 <- cutree(clust, 5)
                
                map1 <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(k1)), data = data) +
                 	scale_fill_manual(name = "Clusters", values = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c")) +
                 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
                 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
                 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
                 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
                   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
                 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
                
                ggsave(plot = map1, filename = paste("map_clusters_",bas,"_",strat,"_",5,".png", sep = ""), dpi = 300, width = 7, height = 5)
                         
        } else if(strat == "PCA+Euclid+Complete") {
            
                # Perform PCA first, retrieve scores and display % var explained along first 4 ncp
                message(paste("Computing PCA + Euclidean distance matrix + Complete link", sep = ""))
                pca <- PCA(X = data[,c(4:length(data))], graph = F, scale.unit = T)
                # Display summary
                message(paste(summary(pca),sep = ""))
                coords <- pca$ind$coord[,c(1:4)]
                # Compute euclidean dist matrix
                dist <- dist(coords,"euclidean") 
                # Derive dendrogram using Ward's aggregation link
                clust <- hclust(dist,"complete")
                data$k <- cutree(clust, 5)
                
                map1 <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(k)), data = data) +
                 	scale_fill_manual(name = "Clusters", values = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c")) +
                 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
                 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
                 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
                 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
                   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
                 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
                
                ggsave(plot = map1, filename = paste("map_clusters_",bas,"_",strat,"_",5,".png", sep = ""), dpi = 300, width = 7, height = 5)	
                   
        } else if(strat == "Mahal+Avg") {
       
                message(paste("Computing Mahalanobis distance matrix + Average link", sep = ""))
                dist <- FD::mahaldis(as.matrix(data[,c(4:length(data))]))
                # Derive dendrogram using Ward's aggregation link
                clust <- hclust(dist,"average")
                data$k <- cutree(clust,5)
                
                map1 <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(k)), data = data) +
                 	scale_fill_manual(name = "Clusters", values = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c")) +
                 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
                 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
                 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
                 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
                   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
                 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
                
                ggsave(plot = map1, filename = paste("map_clusters_",bas,"_",strat,"_",5,".png", sep = ""), dpi = 300, width = 7, height = 5)	
                
         } else if(strat == "Mahal+PAM") {
                 
                 message(paste("Computing Mahalanobis distance matrix + PAM", sep = ""))
                 dist <- FD::mahaldis(as.matrix(data[,c(4:length(data))]))      
                 
                 k <- 3
                 km <- pam(dist, k = k, diss = T, keep.diss = F, do.swap = FALSE) 
                 data$k <- km$cluster
                 message(paste("Mapping the ",k," clusters", sep = ""))
                 map <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(k)), data = data) +
                  	scale_fill_manual(name = "Clusters", values = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c")) +
                  	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
                  	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                                labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
                  	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
                  		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
                    	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
                  		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
                
                 ggsave(plot = map, filename = paste("map_clusters_",bas,"_",strat,"_",k,".png", sep = ""), dpi = 300, width = 7, height = 5)
                 
                 ### And for k = 5
                 k <- 5
                 km <- pam(dist, k = k, diss = T, keep.diss = F, do.swap = FALSE) 
                 data$k <- km$cluster
                 message(paste("Mapping the ",k," clusters", sep = ""))
                 map <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(k)), data = data) +
                  	scale_fill_manual(name = "Clusters", values = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c")) +
                  	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
                  	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                                labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
                  	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
                  		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
                    	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
                  		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
                
                 ggsave(plot = map, filename = paste("map_clusters_",bas,"_",strat,"_",k,".png", sep = ""), dpi = 300, width = 7, height = 5)
      
         } else if(strat == "Mahal+Ward") {
             
                 message(paste("Computing Mahalanobis distance matrix + Ward's link", sep = ""))
                 dist <- FD::mahaldis(as.matrix(data[,c(4:length(data))]))      
                 clust <- hclust(dist,"ward.D2")
                 data$k1 <- cutree(clust,4)
                
                 map1 <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(k1)), data = data) +
                  	scale_fill_manual(name = "Clusters", values = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c")) +
                  	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
                  	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                                labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
                  	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
                  		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
                    	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
                  		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
                
                 ggsave(plot = map1, filename = paste("map_clusters_",bas,"_",strat,"_",4,".png", sep = ""), dpi = 300, width = 7, height = 5)
                 
                 data$k1 <- cutree(clust,5)
                 map1 <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(k1)), data = data) +
                  	scale_fill_manual(name = "Clusters", values = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c")) +
                  	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
                  	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                                labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
                  	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
                  		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
                    	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
                  		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
                
                 ggsave(plot = map1, filename = paste("map_clusters_",bas,"_",strat,"_",5,".png", sep = ""), dpi = 300, width = 7, height = 5)
       
       
             } else if(strat == "Mahal+Complete") {
       
                 message(paste("Computing Mahalanobis distance matrix + Complete link", sep = ""))
                 dist <- FD::mahaldis(as.matrix(data[,c(4:length(data))]))      
                 # Derive dendrogram using complete link
                 clust <- hclust(dist,"complete")
                 data$k <- cutree(clust, 5)
                 map1 <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(k)), data = data) +
                  	scale_fill_manual(name = "Clusters", values = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c")) +
                  	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
                  	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                                labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
                  	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
                  		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
                    	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
                  		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
                
                 ggsave(plot = map1, filename = paste("map_clusters_",bas,"_",strat,"_",5,".png", sep = ""), dpi = 300, width = 7, height = 5)
                 
             
             } else if(strat == "PCA+Euclid+Ward") {
           
                 # Perform PCA first, retrieve scores and display % var explained along first 4 ncp
                 message(paste("Computing PCA + Euclidean distance matrix + Ward's link", sep = ""))
                 pca <- PCA(X = data[,c(4:length(data))], graph = F, scale.unit = T)
                 # Display summary
                 message(paste(summary(pca),sep = ""))
                 coords <- pca$ind$coord[,c(1:4)]
                 # Compute euclidean dist matrix
                 dist <- dist(coords,"euclidean") 
                 # Derive dendrogram using Ward's aggregation link
                 clust <- hclust(dist,"ward.D2")
                 
                 data$k1 <- cutree(clust,4)
                 map1 <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(k1)), data = data) +
                  	scale_fill_manual(name = "Clusters", values = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c")) +
                  	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
                  	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                                labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
                  	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
                  		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
                    	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
                  		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
                
                 ggsave(plot = map1, filename = paste("map_clusters_",bas,"_",strat,"_",4,".png", sep = ""), dpi = 300, width = 7, height = 5)
      
                 ### And for k = 5
                 data$k1 <- cutree(clust,5)
                 map1 <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(k1)), data = data) +
                  	scale_fill_manual(name = "Clusters", values = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c")) +
                  	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
                  	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                                labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
                  	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
                  		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
                    	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
                  		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
                
                 ggsave(plot = map1, filename = paste("map_clusters_",bas,"_",strat,"_",5,".png", sep = ""), dpi = 300, width = 7, height = 5)
      
           
        } # eo if else loop
    
} # eo FUN

setwd(WD)
strategies <- c("PCA+Euclid+PAM","Euclid+PAM","Mahal+PAM",
                "PCA+Euclid+Ward","PCA+Euclid+Avg","PCA+Euclid+Complete",
                "Mahal+Ward","Mahal+Avg","Mahal+Complete")
                
mclapply(X = strategies, FUN = cluster.mapper, mc.cores = 15, bas = "impacts")

### Final choice after examining the maps: 5 strategies
# Euclid+PAM, k = 4 (best choice in CH index profile !)
# PCA+Euclid+Ward, k = 4 (2nd best chice after k = 6, better than k = 5)
# PCA+Euclid+Ward, k = 5 (3rd best choice after k = 6 and 4)
# PCA+Euclid+PAM, k = 5 (2nd/3rd best chocie according to CH profile)
# PCA+Euclid+PAM, k = 6 (best choice according to CH profile)

### Provide those chosen klusters to 'changes' dataframe. Save the data frame as R object and combine with ecosystem services proxies variables
impacts <- na.omit(changes)

# 1) Euclid+PAM, k = 4 
dist <- dist(impacts[,c(4:length(impacts))],"euclidean")
k <- 4
km <- pam(dist, k = k, diss = T, keep.diss = F, do.swap = FALSE) 
impacts$euclid_ward_k4 <- km$cluster

# 2) PCA+Euclid+Ward, k = 4 + k = 5
message(paste("Computing PCA + Euclidean distance matrix + Ward's link", sep = ""))
pca <- PCA(X = impacts[,c(4:length(impacts))], graph = F, scale.unit = T)
summary(pca)
coords <- pca$ind$coord[,c(1:4)]
# Compute euclidean dist matrix
dist <- dist(coords,"euclidean") 
clust <- hclust(dist,"ward.D2")
# Cutree
impacts$pca_euclid_ward_k4 <- cutree(clust,4)
impacts$pca_euclid_ward_k5 <- cutree(clust,5)

# 4) PCA+Euclid+PAM, k = 5 and k = 6
# Use dist above
k <- 5
km <- pam(dist, k = k, diss = T, keep.diss = F, do.swap = F)
impacts$pca_euclid_pam_k5 <- km$cluster

k <- 6
km <- pam(dist, k = k, diss = T, keep.diss = F, do.swap = F)
impacts$pca_euclid_pam_k6 <- km$cluster

### Check
colnames(impacts)
summary(impacts)

setwd(WD)
save(impacts, file = "table_ann_changes_diversity_ensemble_klusters_27_03_20.Rdata")

### --------------------------------------------------------------------------------


### 3°) Get ecosystem services proxies, and merge them with the outputs above. Examine distribution of diversity metrics and services across clusters. 
### Choose final clusters (most informative ones)

library("tidyverse")
library("RColorBrewer")
library("reshape2")
library("viridis")
library("scales")
library("maps")
library("geosphere")
library("rgdal")
library("raster")

world2 <- map_data("world2")
WD <- getwd()

### Re-load table with changes and klusters
impacts <- get(load("table_ann_changes_diversity_ensemble_klusters_27_03_20.Rdata"))
colnames(impacts); head(impacts)

### Now, load the proxies of ecosystem services

### A) Marine biodiversity (Tittensor et al., 2010)
setwd(paste(WD,"/env_predictors/Global_ecosystem_properties/Marine_Biodiversity/Tittensor&al._2010/01_Data", sep = ""))
require("rgdal")
shape <- readOGR(dsn = "WCMC-019-PatternsBiodiversity2010-AcrossTaxa.shp")
# Convert to raster? use a standard 1x1 grid from WOA to use for rasterzing
setwd(paste(WD,"/env_predictors/salinity_masks_WOA13v2", sep = ""))
ras <- raster::raster(dir()[1])
# rasterize the 3 fields
AllNorm <- rasterize(x = shape, y = ras, field = "AllNorm")
CoastNorm <- rasterize(x = shape, y = ras, field = "CoastNorm")
OceanNorm <- rasterize(x = shape, y = ras, field = "OceanNorm")
# plot(OceanNorm)
# Extract value at 'div', need to switch back to -180°/+180°
impacts$x2 <- impacts$x 
impacts[impacts$x > 180 ,"x2"] <- (impacts[impacts$x > 180 ,"x"]) - 360
# Convert to raster and combine with div indices
impacts$AllNorm <- raster::extract(x = AllNorm, y = impacts[,c("x2","y")])
impacts$OceanNorm <- raster::extract(x = OceanNorm, y = impacts[,c("x2","y")])
impacts$CoastNorm <- raster::extract(x = CoastNorm, y = impacts[,c("x2","y")])
# Check
summary(impacts)


### B) Proxies of biogeochemistry: NPP, Cexp/ e ratio
setwd(paste(WD,"/env_predictors/Global_ecosystem_properties/Carbon/DeVries&Weber_2017/", sep = ""))
lat <- raster::stack("Cexp_deVries_2017.nc", varname = "LAT")
lon <- raster::stack("Cexp_deVries_2017.nc", varname = "LON")
y <- as.data.frame(lat, xy = T)
x <- as.data.frame(lon, xy = T)
vars <- c("NPP","FPOCex","FPOC100m")
clims <- lapply(vars, function(v) {
				# Get data from the nc file
				ras <- raster::stack("Cexp_deVries_2017.nc", varname = v)
				# Turn into ddf and provide coordinates
				d <- as.data.frame(ras, xy = T)
				d$x <- x[,3]
				d$y <- y[,3]
				# Provide a cell id 
				d$cell_id <- factor(paste(round(d$x,1), round(d$y,1), sep = "_"))
				# Compute multi-model average (12 models)
				d$avg <- rowMeans(as.matrix(d[,c(3:14)]), na.rm = T)
				# Change colnames 
				colnames(d)[c(3:14)] <- paste("v",c(1:12), sep = "")
				colnames(d)[16] <- v
				if(v == "FPOCex") {
					return(d[,c(1,2,15,16)]) 
				} else {
					return( d[,c(1,2,16)] ) 
				} # eo if else loop
		} # eo FUN
) # eo lapply
poc <- do.call(cbind, clims)
# dim(poc); str(poc)
poc$eratio <- (poc$FPOC100m) / (poc$NPP)
summary(poc)

# Next, convert to raster and combine with div indices
spg <- poc[,c("x","y","FPOCex")]
colnames(spg)[1] <- "x"
coordinates(spg) <- ~ x + y
gridded(spg) <- TRUE
ras <- raster(spg)
crs(ras) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0" 
impacts$FPOCex <- raster::extract(x = ras, y = impacts[,c("x","y")])
### And NPP
spg <- poc[,c("x","y","NPP")]
colnames(spg)[1] <- "x"
coordinates(spg) <- ~ x + y
gridded(spg) <- TRUE
ras <- raster(spg)
crs(ras) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0" 
impacts$NPP <- raster::extract(x = ras, y = impacts[,c("x","y")])
### Compute export efficency (FPOCex/ NPP)
impacts$e <- (impacts$FPOCex) / (impacts$NPP)
summary(impacts$e)
impacts <- impacts[impacts$e <= 0.4,]

### convert to the standard mgC/m2.day
impacts$FPOCex <- (impacts$FPOCex)*(12.0107/365)
impacts$NPP <- (impacts$NPP)*(12.0107/365)
summary(impacts)


### C) Proxy of particle size from space
setwd(paste(WD,"/env_predictors/Global_ecosystem_properties/Carbon/Kostadinov&al._2009", sep = ""))
psd <- read.table("table_annual_PSDslope_Kostadinov_1d_29_01_20.txt", h = T, sep = "\t")
# Check if coords are consistent with those in 'div'
psd$x2 <- (psd$x2)+0.5
spg <- psd[,c("x2","y","slope")]
colnames(spg)[1] <- "x"
coordinates(spg) <- ~ x + y
gridded(spg) <- TRUE
ras <- raster(spg)
crs(ras) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0" 
# plot(ras)
### extract and join with ddf
impacts$slope <- raster::extract(x = ras, y = impacts[,c("x","y")])
summary(impacts$slope)
# High slope = small particles...reverse the scale so that big values correspond to large particles (more logic)
impacts$slope2 <- 1/(impacts$slope)
summary(impacts$slope2)

# Check
summary(impacts) # Remove the 310 obs that have NA coordinates?
impacts <- impacts[!is.na(impacts$x),]

### D) Add annual climatology of pelagics catch rates
setwd("/net/kryo/work/fabioben/OVERSEE/data/env_predictors/Global_ecosystem_properties/Fisheries_Watson2017/catch_data")
fish <- get(load("clim_pelagic_catches_1990-2019_1d.Rdata"))
summary(fish)
# Need to rotate to 0-360° longitude
fish$x2 <- fish$x
fish[fish$x < 0 ,"x2"] <- (fish[fish$x < 0 ,"x"]) + 360
### Quick map to check
# ggplot() + geom_raster(aes(x = x2, y = y, fill = logged), data = fish) +
#       scale_fill_viridis(name = "Mean annual\npelagics catch rate\nlog(t/km2.year)", option = "viridis") +
#       geom_contour(colour = "grey25", binwidth = 1, size = 0.25, aes(x = x2, y = y, z = logged), data = fish) +
#       geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
#       coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
#             labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
#       scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
#             labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
#          theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
#             panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
### Convert to ras
spg <- fish[,c("x2","y","Total")]
colnames(spg)[1] <- "x"
coordinates(spg) <- ~ x + y
gridded(spg) <- TRUE
ras <- raster(spg)
crs(ras) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0" 

plot(log1p(ras)) # OK
### Try to use disaggregate to make smoother maps
dis <- disaggregate(ras, fact = 10, method = 'bilinear')
dis
plot(log1p(dis)) # OK

impacts$catches <- raster::extract(x = dis, y = impacts[,c("x","y")])            
summary(impacts)

### Map the 5 proxies of ecosystem services
colnames(impacts); summary(impacts)

p1 <- ggplot() + geom_raster(aes(x = x, y = y, fill = OceanNorm), data = impacts) +
      scale_fill_viridis(name = "Oceanic\nBiodiversity", option = "inferno") +
      geom_contour(colour = "grey15", binwidth = 0.2, size = 0.25, aes(x = x, y = y, z = OceanNorm), data = impacts) + 
      geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
      coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
            labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
      scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
            labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	  theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
            panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
#                        
p2 <- ggplot() + geom_raster(aes(x = x, y = y, fill = log(NPP)), data = impacts) +
      scale_fill_viridis(name = "NPP\nlog(mgC/m2.day)" ) +
      geom_contour(colour = "grey25", binwidth = 0.5, size = 0.25, aes(x = x, y = y, z = log(NPP) ), data = impacts) + 
      geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
      coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
            labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
      scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
            labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	  theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
            panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
#
p3 <- ggplot() + geom_raster(aes(x = x, y = y, fill = log(FPOCex)), data = impacts) +
      scale_fill_viridis(name = "FPOCex\nlog(mgC/m2.day)" ) +
      geom_contour(colour = "grey25", binwidth = 0.5, size = 0.25, aes(x = x, y = y, z = log(FPOCex) ), data = impacts) + 
      geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
      coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
            labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
      scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
            labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	  theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
            panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
#
p4 <- ggplot() + geom_raster(aes(x = x, y = y, fill = e), data = impacts) +
      scale_fill_viridis(name = "e\n(FPOCex/NPP)" ) +
      geom_contour(colour = "grey25", binwidth = 0.05, size = 0.25, aes(x = x, y = y, z = e), data = impacts) + 
      geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
      coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
            labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
      scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
            labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	  theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
            panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
#
p5 <- ggplot() + geom_raster(aes(x = x, y = y, fill = slope2), data = impacts) +
      scale_fill_viridis(name = "Particles\nsize index", option = "plasma") +
      geom_contour(colour = "grey40", binwidth = 0.05, size = 0.25, aes(x = x, y = y, z = slope2), data = impacts) + 
      geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
      coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
            labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
      scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
            labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	  theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
            panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
#
p6 <- ggplot() + geom_raster(aes(x = x, y = y, fill = log1p(catches)), data = impacts) +
      scale_fill_viridis(name = "Annual pelagics\ncatch rate\nlog(t/km2.year)", option = "viridis") +
      geom_contour(colour = "grey25", binwidth = 2, size = 0.25, aes(x = x, y = y, z = log1p(catches)), data = impacts) + 
      geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
      coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
            labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
      scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
            labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	  theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
            panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
            
# Save maps             
setwd(WD)
ggsave(plot = p1, filename = "map_service_OceanNorm.jpg", dpi = 300, width = 6, height = 5)	
ggsave(plot = p2, filename = "map_service_logNPP.jpg", dpi = 300, width = 6, height = 5)	
ggsave(plot = p3, filename = "map_service_logFPOC.jpg", dpi = 300, width = 6, height = 5)	
ggsave(plot = p4, filename = "map_service_eratio.jpg", dpi = 300, width = 6, height = 5)	
ggsave(plot = p5, filename = "map_service_PSD.jpg", dpi = 300, width = 6, height = 5)	
ggsave(plot = p6, filename = "map_service_catches.jpg", dpi = 300, width = 6, height = 5)

### Save 
save(impacts, file = "table_ann_changes_diversity+services_ensemble_klusters_21_04_20.Rdata")
# impacts <- get(load("table_ann_changes_diversity+services_ensemble_klusters_21_04_20.Rdata"))

### --------------------------------------------------------------------------------

### D) Examine the distrbution of diversity changes and services across clusters with ridgeplots ! 
library("ggridges") # install.packages("ggridges")
library("tidyverse")
library("RColorBrewer")
library("reshape2")
library("viridis")
library("scales")
library("maps")
library("rgdal")
library("raster")

world2 <- map_data("world2")
WD <- getwd()

impacts <- get(load("table_ann_changes_diversity+services_ensemble_klusters_21_04_20.Rdata"))
colnames(impacts); head(impacts)

### Make map and ggridges+boxplots for colnames(impacts)[c(9:13)]
klusters <- colnames(impacts)[c(9:13)]
# k <- "pca_euclid_pam_k6"
for(k in klusters) {
    
        # Message 
        message(paste("Making maps & plots for ",k, sep = ""))
        message(paste("", sep = ""))
        map <- ggplot() + geom_tile(aes(x = x, y = y, fill = factor(get(k))), data = na.omit(impacts)) +
 	        scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
            geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
 	        coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
                    labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
 	        scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
 		            labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	        theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
 		            panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
        
        ggsave(plot = map, filename = paste("map_",k,".jpg",sep = ""), dpi = 300, width = 7, height = 5)              
        
        ### Plot ggridges for impact metrics
        p1 <- ggplot(data = na.omit(impacts), aes(x = rich_phyto, y = factor(get(k)), fill = factor(get(k)) ))+
            geom_density_ridges_gradient(scale = 4, show.legend = F) + theme_ridges() +
            scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
            geom_vline(xintercept = 0, linetype = "dashed") + 
            xlab("Mean ensemble % difference in phytoplankton richness") + ylab("")
        #
        p2 <- ggplot(data = na.omit(impacts), aes(x = rich_zoo, y = factor(get(k)), fill = factor(get(k)) ))+
            geom_density_ridges_gradient(scale = 4, show.legend = F) + theme_ridges() +
            scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
            geom_vline(xintercept = 0, linetype = "dashed") + 
            xlab("Mean ensemble % difference in zooplankton richness") + ylab("")
        #
        p3 <- ggplot(data=na.omit(impacts), aes(x = jac, y = factor(get(k)), fill = factor(get(k)) ))+
            geom_density_ridges_gradient(scale = 4, show.legend = F) + theme_ridges() +
            scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
            xlab("Mean ensemble dissimilarity in plankton composition") + ylab("")
        #
        p4 <- ggplot(data=na.omit(impacts), aes(x = jtu_phyto, y = factor(get(k)), fill = factor(get(k)) ))+
            geom_density_ridges_gradient(scale = 4, show.legend = F) + theme_ridges() +
            scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
            xlab("Mean ensemble turn-over in phytoplankton composition") + ylab("")
        
        p5 <- ggplot(data=na.omit(impacts), aes(x = jtu_zoo, y = factor(get(k)), fill = factor(get(k)) ))+
            geom_density_ridges_gradient(scale = 4, show.legend = F) + theme_ridges() +
            scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
            xlab("Mean ensemble turn-over in zooplankton composition") + ylab("")
        
        ### Plot ggridges for ecosystem services proxies
        p6 <- ggplot(data=na.omit(impacts), aes(x = OceanNorm, y = factor(get(k)), fill = factor(get(k)) ))+
          geom_density_ridges_gradient(scale = 4, show.legend = F) + theme_ridges() +
          scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
          xlab("Oceanic Biodiversity") + ylab("")

        p7 <- ggplot(data=na.omit(impacts), aes(x = log(NPP), y = factor(get(k)), fill = factor(get(k)) ))+
          geom_density_ridges_gradient(scale = 4, show.legend = F) + theme_ridges() +
          scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
          xlab("Surface NPP log(mgC/m2.day)") + ylab("")
  
        p8 <- ggplot(data=na.omit(impacts), aes(x = log(FPOCex), y = factor(get(k)), fill = factor(get(k)) ))+
          geom_density_ridges_gradient(scale = 4, show.legend = F) + theme_ridges() +
          scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
          xlab("POC flux below the euphotic zone log(mgC/m2.day)") + ylab("")
  
        p9 <- ggplot(data=na.omit(impacts), aes(x = e, y = factor(get(k)), fill = factor(get(k)) ))+
          geom_density_ridges_gradient(scale = 4, show.legend = F) + theme_ridges() +
          scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
          xlab("e ratio (FPOCex/NPP)") + ylab("")
  
        p10 <- ggplot(data=na.omit(impacts), aes(x = slope2, y = factor(get(k)), fill = factor(get(k)) ))+
          geom_density_ridges_gradient(scale = 4, show.legend = F) + theme_ridges() +
          scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
          xlab("Particles size (slope of size distribution)") + ylab("")
          
        p11 <- ggplot(data=na.omit(impacts), aes(x = log1p(catches), y = factor(get(k)), fill = factor(get(k)) ))+
            geom_density_ridges_gradient(scale = 4, show.legend = F) + theme_ridges() +
            scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
            xlab("Annual pelagics catch rate log(t/km2.year)") + ylab("")
          
         ggsave(plot = p1, filename = paste("ridgeplot_ens_ann_perc_rich_phyto_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
         ggsave(plot = p2, filename = paste("ridgeplot_ens_ann_perc_rich_zoo_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
         ggsave(plot = p3, filename = paste("ridgeplot_ens_ann_jac_tot_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
         ggsave(plot = p4, filename = paste("ridgeplot_ens_ann_jtu_phyto_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
         ggsave(plot = p5, filename = paste("ridgeplot_ens_ann_jtu_zoo_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
         
         ggsave(plot = p6, filename = paste("ridgeplot_oceanorm_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
         ggsave(plot = p7, filename = paste("ridgeplot_NPP_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
         ggsave(plot = p8, filename = paste("ridgeplot_FPOCex_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
         ggsave(plot = p9, filename = paste("ridgeplot_e_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
         ggsave(plot = p10, filename = paste("ridgeplot_PSI_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
         ggsave(plot = p11, filename = paste("ridgeplot_logcatches_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
         
         ### Same, but with geom_violins and geom_boxplots 
         p1 <- ggplot(data = na.omit(impacts), aes(y = rich_phyto, x = factor(get(k)), fill = factor(get(k)))) +
            geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
            scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) +  
            geom_hline(yintercept = 0, linetype = "dashed") + xlab("") + 
            ylab("Mean ensemble % difference\nin phytoplankton richness") + theme_classic()
         #
         p2 <- ggplot(data = na.omit(impacts), aes(y = rich_zoo, x = factor(get(k)), fill = factor(get(k)))) +
            geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
            scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
            geom_hline(yintercept = 0, linetype = "dashed") + xlab("") + 
            ylab("Mean ensemble % difference\nin zooplankton richness") + theme_classic()
         #
         p3 <- ggplot(data=na.omit(impacts), aes(y = jac, x = factor(get(k)), fill = factor(get(k)) ))+
             geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
             scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
             xlab("") + ylab("Mean ensemble dissimilarity\nin plankton composition") + theme_classic()
         #
         p4 <- ggplot(data=na.omit(impacts), aes(y = jtu_phyto, x = factor(get(k)), fill = factor(get(k)) ))+
             geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
             scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
             ylab("Mean ensemble turn-over\nin phytoplankton composition") + xlab("") + theme_classic()
        
         p5 <- ggplot(data=na.omit(impacts), aes(y = jtu_zoo, x = factor(get(k)), fill = factor(get(k)) ))+
             geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
             scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
             ylab("Mean ensemble turn-over\nin zooplankton composition") + xlab("") + theme_classic()
        
         ### Plot ggridges for ecosystem services proxies
         p6 <- ggplot(data=na.omit(impacts), aes(y = OceanNorm, x = factor(get(k)), fill = factor(get(k)) ))+
           geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
           scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) +  
           ylab("Oceanic Biodiversity") + xlab("") + theme_classic()

         p7 <- ggplot(data=na.omit(impacts), aes(y = log(NPP), x = factor(get(k)), fill = factor(get(k)) ))+
           geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
           scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
           ylab("Surface NPP\nlog(mgC/m2.day)") + xlab("") + theme_classic()
  
         p8 <- ggplot(data=na.omit(impacts), aes(y = log(FPOCex), x = factor(get(k)), fill = factor(get(k)) ))+
           geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
           scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
           ylab("POC flux below the euphotic zone\nlog(mgC/m2.day)") + xlab("") + theme_classic()
  
         p9 <- ggplot(data=na.omit(impacts), aes(y = e, x = factor(get(k)), fill = factor(get(k)) ))+
           geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
           scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
           ylab("e ratio (FPOCex/NPP)") + xlab("") + theme_classic()
  
         p10 <- ggplot(data=na.omit(impacts), aes(y = slope2, x = factor(get(k)), fill = factor(get(k)) ))+
           geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
           scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
           ylab("Particles size\n(slope of size distribution)") + xlab("") + theme_classic()
           
         p11 <- ggplot(data=na.omit(impacts), aes(y = log1p(catches), x = factor(get(k)), fill = factor(get(k)) ))+
             geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
             scale_fill_manual(name = "", values = c("#d6604d","#f4a582","#d1e5f0","#92c5de","#2166ac","#d53e4f")) + 
             ylab("Annual pelagics catch rate log(t/km2.year)")  + xlab("") + theme_classic() 
          
          ggsave(plot = p1, filename = paste("boxplots_ens_ann_perc_rich_phyto_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
          ggsave(plot = p2, filename = paste("boxplots_ens_ann_perc_rich_zoo_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
          ggsave(plot = p3, filename = paste("boxplots_ens_ann_jac_tot_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
          ggsave(plot = p4, filename = paste("boxplots_ens_ann_jtu_phyto_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
          ggsave(plot = p5, filename = paste("boxplots_ens_ann_jtu_zoo_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
         
          ggsave(plot = p6, filename = paste("boxplots_oceanorm_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
          ggsave(plot = p7, filename = paste("boxplots_NPP_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
          ggsave(plot = p8, filename = paste("boxplots_FPOCex_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
          ggsave(plot = p9, filename = paste("boxplots_e_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
          ggsave(plot = p10, filename = paste("boxplots_PSI_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
          ggsave(plot = p11, filename = paste("boxplots_logcatches_",k,".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
          
} # eo for loop - k in klusters


### --------------------------------------------------------------------------------

### 30/03/2020: Choose pca_euclid_pam_k5 and pca_euclid_pam_k6 as final cluster choices. Re-map it more nicely. 

map1 <- ggplot() + geom_tile(aes(x = x, y = y, fill = factor(pca_euclid_pam_k5)), data = na.omit(impacts)) +
    scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#2166ac","#abd9e9","#2166ac")) + 
    geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
    coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
            labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
    scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
            labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
    theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
            panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "bottom" )

map2 <- ggplot() + geom_tile(aes(x = x, y = y, fill = factor(pca_euclid_pam_k6)), data = na.omit(impacts)) +
    scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac")) + 
    geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
    coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
            labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
    scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
            labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
    theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
            panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "bottom")
#
ggsave(plot = map1, filename = paste("map_","pca_euclid_pam_k5",".jpg",sep = ""), dpi = 300, width = 7, height = 5)  
ggsave(plot = map2, filename = paste("map_","pca_euclid_pam_k6",".jpg",sep = ""), dpi = 300, width = 7, height = 5)  



### Same, but with geom_violins and geom_boxplots 
p1 <- ggplot(data = na.omit(impacts), aes(y = rich_phyto, x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6))) +
   geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
   scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac")) +  
   geom_hline(yintercept = 0, linetype = "dashed") + xlab("") + 
   ylab("Mean ensemble % difference\nin phytoplankton richness") + theme_classic()
#
p2 <- ggplot(data = na.omit(impacts), aes(y = rich_zoo, x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6))) +
   geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
   scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac")) + 
   geom_hline(yintercept = 0, linetype = "dashed") + xlab("") + 
   ylab("Mean ensemble % difference\nin zooplankton richness") + theme_classic()
#
p3 <- ggplot(data=na.omit(impacts), aes(y = jac, x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6)))+
    geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
    scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac")) + 
    xlab("") + ylab("Mean ensemble dissimilarity\nin plankton composition") + theme_classic()
#
p4 <- ggplot(data=na.omit(impacts), aes(y = jtu_phyto, x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6)))+
    geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
    scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac")) + 
    ylab("Mean ensemble turn-over\nin phytoplankton composition") + xlab("") + theme_classic()

p5 <- ggplot(data=na.omit(impacts), aes(y = jtu_zoo, x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6)))+
    geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
    scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac")) + 
    ylab("Mean ensemble turn-over\nin zooplankton composition") + xlab("") + theme_classic()

### Plot ggridges for ecosystem services proxies
p6 <- ggplot(data=na.omit(impacts), aes(y = OceanNorm, x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6)))+
  geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
  scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac")) +  
  ylab("Oceanic Biodiversity") + xlab("") + theme_classic()

p7 <- ggplot(data=na.omit(impacts), aes(y = log(NPP), x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6)))+
  geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
  scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac")) + 
  ylab("Surface NPP\nlog(mgC/m2.day)") + xlab("") + theme_classic()

p8 <- ggplot(data=na.omit(impacts), aes(y = log(FPOCex), x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6)))+
  geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
  scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac")) + 
  ylab("POC flux below the euphotic zone\nlog(mgC/m2.day)") + xlab("") + theme_classic()

p9 <- ggplot(data=na.omit(impacts), aes(y = e, x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6)))+
  geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
  scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac")) + 
  ylab("e ratio (FPOCex/NPP)") + xlab("") + theme_classic()

p10 <- ggplot(data=na.omit(impacts), aes(y = slope2, x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6)))+
  geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
  scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac") )+ 
  ylab("Particles size\n(slope of size distribution)") + xlab("") + theme_classic()

p11 <- ggplot(data=na.omit(impacts), aes(y = log1p(catches), x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6)))+
  geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
  scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac") )+ 
  ylab("Annual pelagics catch rate\nlog(t/km2.year)") + xlab("") + theme_classic()
  
ggsave(plot = p1, filename = paste("boxplots_ens_ann_perc_rich_phyto_","pca_euclid_pam_k6",".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
ggsave(plot = p2, filename = paste("boxplots_ens_ann_perc_rich_zoo_","pca_euclid_pam_k6",".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
ggsave(plot = p3, filename = paste("boxplots_ens_ann_jac_tot_","pca_euclid_pam_k6",".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
ggsave(plot = p4, filename = paste("boxplots_ens_ann_jtu_phyto_","pca_euclid_pam_k6",".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
ggsave(plot = p5, filename = paste("boxplots_ens_ann_jtu_zoo_","pca_euclid_pam_k6",".jpg",sep=""), dpi = 300, width = 6, height = 4.5)

ggsave(plot = p6, filename = paste("boxplots_oceanorm_","pca_euclid_pam_k6",".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
ggsave(plot = p7, filename = paste("boxplots_NPP_","pca_euclid_pam_k6",".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
ggsave(plot = p8, filename = paste("boxplots_FPOCex_","pca_euclid_pam_k6",".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
ggsave(plot = p9, filename = paste("boxplots_e_","pca_euclid_pam_k6",".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
ggsave(plot = p10, filename = paste("boxplots_PSI_","pca_euclid_pam_k6",".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
ggsave(plot = p11, filename = paste("boxplots_catches_","pca_euclid_pam_k6",".jpg",sep=""), dpi = 300, width = 6, height = 4.5)

### Check without non logged
ggplot(data = na.omit(impacts), aes(y = NPP, x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6)))+
  geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
  scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac")) + 
  scale_y_continuous(limits = c(0,800)) + 
  ylab("Surface NPP\n(mgC/m2.day)") + xlab("") + theme_classic()

ggplot(data = na.omit(impacts), aes(y = FPOCex, x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6)))+
  geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
  scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac")) + 
  scale_y_continuous(limits = c(0,150)) + 
  ylab("POC flux below the euphotic zone\n(mgC/m2.day)") + xlab("") + theme_classic()

ggplot(data=na.omit(impacts), aes(y = catches, x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6)))+
    geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
    scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac") ) +
    scale_y_continuous(limits = c(0,75)) + ylab("Annual pelagics catch rate\n(t/km2.year)") + 
    xlab("") + theme_classic()
    
#
ggplot(data = impacts[!(impacts$y < 30 & impacts$pca_euclid_pam_k6 == 6),],
        aes(y = log1p(catches), x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6)))+
    geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
    scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#abd9e9","#2166ac") ) +
    scale_y_continuous(limits = c(0,6)) + ylab("Annual pelagics catch rate\nlog(t/km2.year)") + 
    xlab("") + theme_classic()
    
       
### Perform pair-wise kruskal-wallis tests to identify which differences are "significant"
colnames(impacts)
## A) For changes in diversity
kruskal.test(rich_phyto ~ factor(pca_euclid_pam_k6), data = impacts) # Kruskal-Wallis chi-squared = 25445, df = 5, p-value < 2.2e-16
# Highly signif. the null hypothesis is rejected.  Thus, it is meaningful to apply post-hoc tests with the function posthoc.kruskal.nemenyi.test()
library("PMCMR")
# ?posthoc.kruskal.nemenyi.test
posthoc.kruskal.nemenyi.test(rich_phyto ~ factor(pca_euclid_pam_k6), data = impacts, dist = "Tukey")
posthoc.kruskal.dunn.test(rich_phyto ~ factor(pca_euclid_pam_k6), data = impacts, p.adjust = "bonf")
# 2 vs. 3 --> n.s.

### results are the same with Chisquare distance 

kruskal.test(rich_zoo ~ factor(pca_euclid_pam_k6), data = impacts) # Kruskal-Wallis chi-squared = 18961, df = 5, p-value < 2.2e-16
posthoc.kruskal.nemenyi.test(rich_zoo ~ factor(pca_euclid_pam_k6), data = impacts, dist = "Tukey")
# all signif ! 

kruskal.test(jac ~ factor(pca_euclid_pam_k6), data = impacts) # Kruskal-Wallis chi-squared = 25039, df = 5, p-value < 2.2e-16
posthoc.kruskal.nemenyi.test(jac ~ factor(pca_euclid_pam_k6), data = impacts, dist = "Tukey")
# all signif !!

kruskal.test(jtu_phyto ~ factor(pca_euclid_pam_k6), data = impacts) # Kruskal-Wallis chi-squared = 22709, df = 5, p-value < 2.2e-16
posthoc.kruskal.nemenyi.test(jtu_phyto ~ factor(pca_euclid_pam_k6), data = impacts, dist = "Tukey")
# all signif !!

kruskal.test(jtu_zoo ~ factor(pca_euclid_pam_k6), data = impacts) # Kruskal-Wallis chi-squared = 22073, df = 5, p-value < 2.2e-16
posthoc.kruskal.nemenyi.test(jtu_zoo ~ factor(pca_euclid_pam_k6), data = impacts, dist = "Tukey")
# all signif !!


## B) For ecosystem services
kruskal.test(OceanNorm ~ factor(pca_euclid_pam_k6), data = impacts) # Kruskal-Wallis chi-squared = 16752, df = 5, p-value < 2.2e-16 
posthoc.kruskal.nemenyi.test(OceanNorm ~ factor(pca_euclid_pam_k6), data = impacts, dist = "Chisquare") # need to corretc for ties
# 1-2 n.s
# 5-6 n.s
# And with a p-value adjust method?
posthoc.kruskal.dunn.test(OceanNorm ~ factor(pca_euclid_pam_k6), data = impacts, p.adjust="bonf")

kruskal.test(log(NPP) ~ factor(pca_euclid_pam_k6), data = na.omit(impacts)) # Kruskal-Wallis chi-squared = 9837.3, df = 5, p-value < 2.2e-16
posthoc.kruskal.nemenyi.test(log(NPP) ~ factor(pca_euclid_pam_k6), data = na.omit(impacts), dist = "Chisquare") # all signif...
posthoc.kruskal.dunn.test(log(NPP) ~ factor(pca_euclid_pam_k6), data = impacts, p.adjust="bonf") # ok...all signif :D
posthoc.kruskal.conover.test(log(NPP) ~ factor(pca_euclid_pam_k6), data = impacts, p.adjust="bonf") # ok..


kruskal.test(log(FPOCex) ~ factor(pca_euclid_pam_k6), data = impacts) # Kruskal-Wallis chi-squared = 6369.5, df = 5, p-value < 2.2e-16
posthoc.kruskal.nemenyi.test(log(FPOCex) ~ factor(pca_euclid_pam_k6), data = impacts, dist = "Chisquare") # all signif...
posthoc.kruskal.dunn.test(log(FPOCex) ~ factor(pca_euclid_pam_k6), data = impacts, p.adjust = "bonf") # ok...all signif :D
posthoc.kruskal.conover.test(log(FPOCex) ~ factor(pca_euclid_pam_k6), data = impacts, p.adjust = "bonf") # ok..
# 1-6 n.s

kruskal.test(e ~ factor(pca_euclid_pam_k6), data = impacts) # Kruskal-Wallis chi-squared = 21907, df = 5, p-value < 2.2e-16
posthoc.kruskal.nemenyi.test(e ~ factor(pca_euclid_pam_k6), data = impacts, dist = "Chisquare") 
posthoc.kruskal.dunn.test(e ~ factor(pca_euclid_pam_k6), data = impacts, p.adjust = "bonf") 
posthoc.kruskal.conover.test(e ~ factor(pca_euclid_pam_k6), data = impacts, p.adjust = "bonf") 
# 4-6 n.s

kruskal.test(slope2 ~ factor(pca_euclid_pam_k6), data = impacts) # Kruskal-Wallis chi-squared = 12081, df = 5, p-value < 2.2e-16
posthoc.kruskal.nemenyi.test(slope2 ~ factor(pca_euclid_pam_k6), data = impacts, dist = "Chisquare") # all signif...
posthoc.kruskal.dunn.test(slope2 ~ factor(pca_euclid_pam_k6), data = impacts, p.adjust = "bonf") # ok...all signif :D
posthoc.kruskal.conover.test(slope2 ~ factor(pca_euclid_pam_k6), data = impacts, p.adjust = "bonf") # ok..

kruskal.test(log1p(catches) ~ factor(pca_euclid_pam_k6), data = impacts) # Kruskal-Wallis chi-squared = 9683.3, df = 5, p-value < 2.2e-16
posthoc.kruskal.nemenyi.test(log1p(catches) ~ factor(pca_euclid_pam_k6), data = impacts, dist = "Chisquare") # 
posthoc.kruskal.dunn.test(log1p(catches) ~ factor(pca_euclid_pam_k6), data = impacts, p.adjust = "bonf") # 
posthoc.kruskal.conover.test(log1p(catches) ~ factor(pca_euclid_pam_k6), data = impacts, p.adjust = "bonf")
# 3-4 n.s 


### 21/04/2010: the fisheries product is a rather tricky one to use...examine change sin plankton diversity across quantiles of catches
impacts$catch_q <- factor( cut(log1p(impacts$catches), breaks = quantile(x = log1p(impacts$catches), probs = 0:5/5), include.lowest = T) ) 
#summary(impacts$catch_q)
unique(impacts$catch_q)
levels(impacts$catch_q)[levels(impacts$catch_q) == "[0,0.0748]"] <- "Lowest (0-0.07)"
levels(impacts$catch_q)[levels(impacts$catch_q) == "(0.0748,1.54]"] <- "Low (0.07-1.54)"
levels(impacts$catch_q)[levels(impacts$catch_q) == "(1.54,2.63]"] <- "Interm. (1.54-2.63)"
levels(impacts$catch_q)[levels(impacts$catch_q) == "(2.63,3.4]"] <- "High (2.63-3.40)"
levels(impacts$catch_q)[levels(impacts$catch_q) == "(3.4,8.83]"] <- "Highest (3.40-8.83)"

# Map quickly
map <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(catch_q)), data = na.omit(impacts)) +
   scale_fill_brewer(name = "Catch rates classes\nlog(t/km2.year)", palette = "YlGnBu") + 
   geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
   coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
           labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
   scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
           labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
           panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
#
ggsave(plot = map, filename = "map_catch_rates_classes.jpg", dpi = 300, width = 7, height = 5)
          
### Ok, now examine distrbution of ensemble annual changes in plankton diversity across 'catch_q'
colnames(impacts)

p1 <- ggplot(data = impacts, aes(y = rich_phyto, x = factor(catch_q), fill = factor(catch_q))) +
  geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
  scale_fill_brewer(name = "Catch rates classes\nlog(t/km2.year)", palette = "YlGnBu") + 
  scale_x_discrete(labels = c("Lowest","Lower","Interm.","Higher","Highest")) + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  ylab("Mean % difference in Phytoplankton SR") + xlab("") + theme_classic()

p2 <- ggplot(data = impacts, aes(y = rich_zoo, x = factor(catch_q), fill = factor(catch_q))) +
  geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
  scale_fill_brewer(name = "Catch rates classes\nlog(t/km2.year)", palette = "YlGnBu") + 
  scale_x_discrete(labels = c("Lowest","Lower","Interm.","Higher","Highest")) + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  ylab("Mean % difference in Zooplankton SR") + xlab("") + theme_classic()

p3 <- ggplot(data = impacts, aes(y = jac, x = factor(catch_q), fill = factor(catch_q))) +
  geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
  scale_fill_brewer(name = "Catch rates\nclasses\nlog(t/km2.year)", palette = "YlGnBu") + 
  scale_x_discrete(labels = c("Lowest","Lower","Interm.","Higher","Highest")) + 
  ylab("Mean composition dissimilarity") + xlab("") + theme_classic() 

p4 <- ggplot(data = impacts, aes(y = jtu_phyto, x = factor(catch_q), fill = factor(catch_q))) +
  geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
  scale_fill_brewer(name = "Catch rates classes\nlog(t/km2.year)", palette = "YlGnBu") + 
  scale_x_discrete(labels = c("Lowest","Lower","Interm.","Higher","Highest")) + 
  ylab("Mean Phytoplankton turn-over") + xlab("") + theme_classic()

p5 <- ggplot(data = impacts, aes(y = jtu_zoo, x = factor(catch_q), fill = factor(catch_q))) +
  geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
  scale_fill_brewer(name = "Catch rates classes\nlog(t/km2.year)", palette = "YlGnBu") + 
  scale_x_discrete(labels = c("Lowest","Lower","Interm.","Higher","Highest")) + 
  ylab("Mean Zooplankton turn-over") + xlab("") + theme_classic()

### Save plots just in case
ggsave(plot = p1, filename = "boxplot_ann_perc_phyto_ensemble_catchq.jpg", dpi = 300, width = 8, height = 4)
ggsave(plot = p2, filename = "boxplot_ann_perc_zoo_ensemble_catchq.jpg", dpi = 300, width = 8, height = 4)
ggsave(plot = p3, filename = "boxplot_ann_perc_jac_ensemble_catchq.jpg", dpi = 300, width = 8, height = 4)
ggsave(plot = p4, filename = "boxplot_ann_perc_jtu_phyto_ensemble_catchq.jpg", dpi = 300, width = 8, height = 4)
ggsave(plot = p5, filename = "boxplot_ann_perc_jtu_zoo_ensemble_catchq.jpg", dpi = 300, width = 8, height = 4)



### --------------------------------------------------------------------------------

### 29/04/2020: Check smallest size fraction of pelagics

library("tidyverse")
library("RColorBrewer")
library("reshape2")
library("viridis")
library("scales")
library("maps")
library("rgdal")
library("raster")
library("ggridges")

world2 <- map_data("world2")
WD <- getwd()

impacts <- get(load("table_ann_changes_diversity+services_ensemble_klusters_21_04_20.Rdata"))
head(impacts)

setwd("/net/kryo/work/fabioben/OVERSEE/data/env_predictors/Global_ecosystem_properties/Fisheries_Watson2017/catch_data")
fish <- get(load("clim_pelagic<30cm_catches_1990-2019_1d.Rdata"))
summary(fish)

# Need to rotate to 0-360° longitude
fish$x2 <- fish$x
fish[fish$x < 0 ,"x2"] <- (fish[fish$x < 0 ,"x"]) + 360

# Quick map to check
ggplot() + geom_raster(aes(x = x2, y = y, fill = logged), data = fish) +
       scale_fill_viridis(name = "Mean annual\npelagics catch rate\nlog(t/km2.year)", option = "viridis") +
       geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
       coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
             labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
       scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
             labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
          theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
             panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
             
### Convert to ras
spg <- fish[,c("x2","y","logged")]
colnames(spg)[1] <- "x"
coordinates(spg) <- ~ x + y
gridded(spg) <- TRUE
ras <- raster(spg)
crs(ras) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0" 
plot(log1p(ras)) # OK

impacts$small_catches <- raster::extract(x = ras, y = impacts[,c("x","y")])            
summary(impacts)

# resave impacts
save(impacts, file = "table_ann_changes_diversity+services_ensemble_klusters_11_06_20.Rdata")

# summary(log1p(impacts$small_catches))

### Plot distribution of smllest pelagics size fraction 
### NOTE: exclude k = 5 from this analysis because there are almost no reported catches in the SO

plot1 <- ggplot(data = impacts[impacts$pca_euclid_pam_k6 != 5,],
    aes(y = small_catches, x = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6))) +
  geom_violin(colour = "black") + geom_boxplot(fill = "white", colour = "black", width = 0.1) + 
  scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#2166ac") )+ 
  ylab("Annual small (<30cm) pelagics catch rate\nlog(t/km2.year)") + xlab("") + theme_classic()

# And with ggridges
plot2 <- ggplot(data = impacts[impacts$pca_euclid_pam_k6 != 5,],
    aes(x = small_catches, y = factor(pca_euclid_pam_k6), fill = factor(pca_euclid_pam_k6))) +
    geom_density_ridges_gradient(scale = 4, show.legend = F) + theme_ridges() +
    scale_fill_manual(name = "", values = c("#d73027","#f46d43","#fee090","#66c2a5","#2166ac")) + 
    xlab("Annual small (<30cm) pelagics catch rate log(t/km2.year)") + ylab("")

# Save plot
setwd("/net/kryo/work/fabioben/OVERSEE/data/")
ggsave(plot = plot1, filename = paste("boxplots_smallcatches_","pca_euclid_pam_k6",".jpg",sep=""), dpi = 300, width = 6, height = 4.5)
ggsave(plot = plot2, filename = paste("ridgeplot_smallcatches_","pca_euclid_pam_k6",".jpg",sep=""), dpi = 300, width = 6, height = 4.5)

# Perform variance analysis
library("PMCMR")
kruskal.test(small_catches ~ factor(pca_euclid_pam_k6), data = impacts[impacts$pca_euclid_pam_k6 != 5,])
# Kruskal-Wallis chi-squared = 778.11, df = 4, p-value < 2.2e-16
posthoc.kruskal.nemenyi.test(small_catches ~ factor(pca_euclid_pam_k6), data = impacts[impacts$pca_euclid_pam_k6 != 5,], dist = "Chisquare")
# 1 vs. 2 ns 
posthoc.kruskal.dunn.test(small_catches ~ factor(pca_euclid_pam_k6), data = impacts[impacts$pca_euclid_pam_k6 != 5,], p.adjust = "bonf")
# 1 vs. 2 ns 
posthoc.kruskal.conover.test(small_catches ~ factor(pca_euclid_pam_k6), data = impacts[impacts$pca_euclid_pam_k6 != 5,], p.adjust = "bonf")
# 1 vs. 2 ns 


# --------------------------------------------------------------------------------------------------------------------------------

### 30/04/2020: Make figure panel with ggarrange() to put in appendices
### For each variable of diversity change (∆%SRphyto, ∆%SRzoo, Jac, JTUphyto, JTUzoo) and then each 6 services proxy ()
### draw the map and the boxplot per clusters k6 PCA+PAM...on the figure panel, make 4 columns (map, plot, map, plot) and
### 6 rows, and complete the missing spot with the klusters map

library("tidyverse")
library("RColorBrewer")
library("reshape2")
library("viridis")
library("cmocean")
library("scales")
library("maps")
library("rgdal")
library("raster")
library("ggpubr")

world2 <- map_data("world2")
WD <- getwd()

impacts <- get(load("table_ann_changes_diversity+services_ensemble_klusters_11_06_20.Rdata"))
colnames(impacts); head(impacts)

### 15/06/2020: Re-plot distrbutions per regions based on ranks of severity
impacts$rank <- NA
for(k in unique(impacts$pca_euclid_pam_k6)) {
    impacts[which(impacts$pca_euclid_pam_k6 == 1),"rank"] <- 4
    impacts[which(impacts$pca_euclid_pam_k6 == 2),"rank"] <- 3
    impacts[which(impacts$pca_euclid_pam_k6 == 3),"rank"] <- 6
    impacts[which(impacts$pca_euclid_pam_k6 == 4),"rank"] <- 2
    impacts[which(impacts$pca_euclid_pam_k6 == 5),"rank"] <- 5
    impacts[which(impacts$pca_euclid_pam_k6 == 6),"rank"] <- 1
}

### First, the clusters map, with your favourite color palette
# cols <- cmocean('delta')(9)[c(2,4,3,5:7)]
# cols <- c("1" = "#1a9850", "2" = "#a6d96a", "3" = "#fee08b", "4" = "#3288bd", "5" = "#abd9e9", "6" = "#d53e4f")

mapA <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(rank)), data = impacts) +
	scale_fill_brewer(name = "", palette = "RdYlBu") +
 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "#BAB0AC", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "right")
#
ggsave(plot = mapA, filename = "mapA_clusters.jpg", dpi = 300, width = 5, height = 3)

# MapB should be the overall Jaccard index 
mapB <- ggplot() + geom_raster(aes(x = x, y = y, fill = jac), data = impacts) +
 	scale_fill_viridis(name = "Mean Jaccard\nindex", option = "viridis", limits = c(0,0.8)) +
 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "#BAB0AC", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "left")

# MapC should be the ∆SR phyto
mapC <- ggplot() + geom_raster(aes(x = x, y = y, fill = rich_phyto), data = impacts) +
 	scale_fill_gradient2(name = "Richness\ndifference (%)", low = "#3288bd", high = "#d53e4f", mid = "white") +
 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "#BAB0AC", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "left")

# MapD should be the ∆SR zoopl
mapD <- ggplot() + geom_raster(aes(x = x, y = y, fill = rich_zoo), data = impacts) +
 	scale_fill_gradient2(name = "Richness\ndifference (%)", low = "#3288bd", high = "#d53e4f", mid = "white") +
 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "#BAB0AC", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "left")

# MapE: JTU phyto
mapE <- ggplot() + geom_raster(aes(x = x, y = y, fill = jtu_phyto), data = impacts) +
 	scale_fill_viridis(name = "Phytoplankton\nturn-over", option = "viridis", limits = c(0,0.75)) +
 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "#BAB0AC", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "left")

# MapF: JTU zoo
mapF <- ggplot() + geom_raster(aes(x = x, y = y, fill = jtu_zoo), data = impacts) +
 	scale_fill_viridis(name = "Zooplankton\nturn-over", option = "viridis", limits = c(0,0.75)) +
 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "#BAB0AC", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "left")
        
        
### And the associated boxplots
box1 <- ggplot(data = impacts, aes(y = jac, x = factor(rank), fill = factor(rank))) +
          geom_boxplot(colour = "black") + scale_fill_brewer(name = "", palette = "RdYlBu", guide = F) +
          scale_y_continuous(position = "right", name = "Mean Jaccard index") + 
          xlab("") + theme_classic()
#
box2 <- ggplot(data = impacts, aes(y = rich_phyto, x = factor(rank), fill = factor(rank))) +
          geom_boxplot(colour = "black") + scale_fill_brewer(name = "", palette = "RdYlBu", guide = F) +
          geom_hline(yintercept = 0, linetype = "dashed") + 
          scale_y_continuous(position = "right", name = "Difference in mean annual\nphytoplankton richness (%)") + 
          xlab("") + theme_classic() 
#
box3 <- ggplot(data = impacts, aes(y = rich_zoo, x = factor(rank), fill = factor(rank))) +
          geom_boxplot(colour = "black") + scale_fill_brewer(name = "", palette = "RdYlBu", guide = F) +
          geom_hline(yintercept = 0, linetype = "dashed") + 
          scale_y_continuous(position = "right", name = "Difference in mean annual\nzooplankton richness (%)") + 
          xlab("") + theme_classic() 
#
box4 <- ggplot(data = impacts, aes(y = jtu_phyto, x = factor(rank), fill = factor(rank))) +
          geom_boxplot(colour = "black") + scale_fill_brewer(name = "", palette = "RdYlBu", guide = F) +
          scale_y_continuous(position = "right", name = "Mean annual\nphytoplankton turn-over") + 
          xlab("") + theme_classic() 
#
box5 <- ggplot(data = impacts, aes(y = jtu_zoo, x = factor(rank), fill = factor(rank))) +
          geom_boxplot(colour = "black") + scale_fill_brewer(name = "", palette = "RdYlBu", guide = F) +
          scale_y_continuous(position = "right", name = "Mean annual\nzooplankton turn-over") + 
          xlab("") + theme_classic() 

### Test first part of the panel
### SOMEHOW GGARRANGE DOESNT WORK HERE, use grid.arrange instead
library("gridExtra")    
?grid.arrange
grid.arrange(grobs = list(mapE,box4), ncol = 2, nrow = 1, widths = c(2.5,1) )
grid.arrange(grobs = list(mapA,box1,mapB,box1,mapC,box2,mapD,box3,mapE,box4,mapF,box5), ncol = 2, nrow = 6, widths = c(2.5,1) )

library("ggpubr")
ggarrange(map,box, labels = c("",""), ncol = 2, nrow = 1, widths = c(2,1))
ggarrange(map,box, labels = c("",""), ncol = 2, nrow = 1, widths = c(2,1))
ggarrange(mapE,box4, labels = c("",""), ncol = 2, nrow = 1, widths = c(2,1))
ggarrange(mapF,box5, labels = c("",""), ncol = 2, nrow = 1, widths = c(2,1))

setwd(WD)
panel <- ggarrange(mapB,box1,mapC,box2,mapD,box3,mapE,box4,mapF,box5, labels = LETTERS[3:12], ncol = 2, nrow = 5, widths = c(2.5,1))
ggsave(plot = panel, filename = "panel.jpg", dpi = 300, width = 10, height = 13.5)


### Same with services
colnames(impacts)

# OceanNorm
mapB <- ggplot() + geom_raster(aes(x = x, y = y, fill = OceanNorm), data = impacts) +
 	scale_fill_viridis(name = "Oceanic\nBiodiversity\n(normalized)", option = "inferno") +
 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "#BAB0AC", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "left")

# Small pelagics fisheries
mapC <- ggplot() + geom_raster(aes(x = x, y = y, fill = small_catches), data = impacts) +
 	scale_fill_viridis(name = "Small pelagics\ncatch rate\nlog(t/km2.year)", option = "inferno", limits = c(0,7.1)) +
 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "#BAB0AC", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "left")

# NPP
mapD <- ggplot() + geom_raster(aes(x = x, y = y, fill = NPP), data = impacts) +
 	scale_fill_viridis(name = "NPP\n(mgC/m2.d)", option = "inferno", limits = c(0,1500)) +
 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "#BAB0AC", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "left")

# FPOCex
mapE <- ggplot() + geom_raster(aes(x = x, y = y, fill = FPOCex), data = impacts) +
 	scale_fill_viridis(name = "FPOC\n(mgC/m2.d)", option = "inferno", limits = c(0,400)) +
 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "#BAB0AC", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "left")

# e ratio
mapF <- ggplot() + geom_raster(aes(x = x, y = y, fill = e), data = impacts) +
 	scale_fill_viridis(name = "e ratio\n(FPOC/NPP)", option = "inferno") +
 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "#BAB0AC", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "left")
        
# PSD slope
mapG <- ggplot() + geom_raster(aes(x = x, y = y, fill = slope2), data = impacts) +
 	scale_fill_viridis(name = "Plankton\nsize index\n(PSD slope)", option = "inferno") +
 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "#BAB0AC", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
 		      labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "left")

### boxplots       
box1 <- ggplot(data = impacts, aes(y = OceanNorm, x = factor(rank), fill = factor(rank))) +
          geom_boxplot(colour = "black") + scale_fill_brewer(name = "", palette = "RdYlBu", guide = F) +
          scale_y_continuous(position = "right", name = "Oceanic Biodiversity\n(normalized species richness)") + 
          xlab("") + theme_classic()
#
box2 <- ggplot(data = impacts[impacts$rank != 5,], aes(y = small_catches, x = factor(rank), fill = factor(rank))) +
          geom_boxplot(colour = "black") + scale_fill_brewer(name = "", palette = "RdYlBu", guide = F) +
          scale_y_continuous(position = "right", name = "Small pelagics catch rate\nlog(t/km2.year)", limits = c(0,7.1)) + 
          xlab("") + theme_classic() 
#
box3 <- ggplot(data = impacts, aes(y = NPP, x = factor(rank), fill = factor(rank))) +
          geom_boxplot(colour = "black") + scale_fill_brewer(name = "", palette = "RdYlBu", guide = F) +
          scale_y_continuous(position = "right", name = "NPP\n(mgC/m2.day)", limits = c(0,850) ) + 
          xlab("") + theme_classic() 
#
box4 <- ggplot(data = impacts, aes(y = FPOCex, x = factor(rank), fill = factor(rank))) +
          geom_boxplot(colour = "black") + scale_fill_brewer(name = "", palette = "RdYlBu", guide = F) +
          scale_y_continuous(position = "right", name = "FPOC\n(mgC/m2.day)", limits = c(0,275) ) + 
          xlab("") + theme_classic() 
#
box5 <- ggplot(data = impacts, aes(y = e, x = factor(rank), fill = factor(rank))) +
          geom_boxplot(colour = "black") + scale_fill_brewer(name = "", palette = "RdYlBu", guide = F) +
          scale_y_continuous(position = "right", name = "e ratio\n(FPOC/NPP)") + 
          xlab("") + theme_classic() 
#
box6 <- ggplot(data = impacts, aes(y = slope2, x = factor(rank), fill = factor(rank))) +
          geom_boxplot(colour = "black") + scale_fill_brewer(name = "", palette = "RdYlBu", guide = F) +
          scale_y_continuous(position = "right", name = "Plankton size index\n(PSD slope)") + 
          xlab("") + theme_classic() 

### Panel
setwd(WD)
panel <- ggarrange(mapB,box1,mapC,box2,mapD,box3,mapE,box4,mapF,box5,mapG,box6, labels = LETTERS[13:24], ncol = 2, nrow = 6, widths = c(2.5,1))
ggsave(plot = panel, filename = "panel2.jpg", dpi = 300, width = 9.7, height = 14.5)


# --------------------------------------------------------------------------------------------------------------------------------

### 11/06/2020: Use PCA to quantify plankton community sensitivity and thus derive a quantitative metric of risk/vulnerability to cc
### Based on the clustering approaches above, use the same PCA (and its components) to quantify the cells' sensitivity to cc
ddf <- get(load("table_ann_changes_diversity+services_ensemble_klusters_11_06_20.Rdata"))
dim(ddf) ; colnames(ddf)
# Ok, first perform the PCA like in the clsuerting and map PCs
require("FactoMineR")
require("ggrepel")
ncp <- 4
pca <- PCA(X = ddf[,c(4:8)], graph = F, scale.unit = T, ncp = ncp)
# Display summary
message(paste(summary(pca),sep = ""))
pc1 <- round(pca$eig[1,2],2); pc1
pc2 <- round(pca$eig[2,2],2); pc2
pc3 <- round(pca$eig[3,2],2); pc3
pc4 <- round(pca$eig[4,2],2); pc4
pc1+pc2+pc3#+pc4

augment.PCA <- function(x, dims=c(1:ncp), which="col") {
  .get <- function(x, element, dims) {
    y <- as.data.frame(x[[element]]$coord[,dims])
    if (nrow(y) == 0) {
      y <- NULL
    } else {
      y$type <- element
    }
    return(y)
  }
  if (which == "col") {
    y <- rbind(.get(x, "var", dims), .get(x, "quanti.sup", dims))
  } else {
    y <- rbind(.get(x, "ind", dims), .get(x, "quali.sup", dims))
  }
  y$var <- row.names(y)
  row.names(y) <- NULL
  return(y)
}
# plot it
pcad <- augment.PCA(pca)
quartz()
ggplot(pcad) +
    coord_fixed() + scale_x_continuous(breaks=0) + scale_y_continuous(breaks=0) +
    annotate(geom="path", colour="black", x=cos(seq(0, 2*pi, length.out=100)), y=sin(seq(0, 2*pi, length.out=100))) +
    geom_segment(aes(x=0, xend = Dim.1, y=0, yend = Dim.2, colour = type), arrow=arrow(angle=20, length=unit(0.01, "npc"))) +
    scale_colour_manual(values = c("#225ea8","#3288bd")) + 
    geom_text_repel(aes(x=Dim.1, y=Dim.2, colour=type, label=var), 
              data=filter(pcad, (Dim.1^2+Dim.2^2) > 0.2^2), segment.alpha=0.5) +
    xlab(paste("PC1 ","(",pc1,"%)", sep="")) + ylab(paste("PC2 ","(",pc2,"%)", sep="")) + theme_bw()

# 2 other PCs
quartz()
ggplot(pcad) +
    coord_fixed() + scale_x_continuous(breaks=0) + scale_y_continuous(breaks=0) +
    annotate(geom="path", colour="black", x=cos(seq(0, 2*pi, length.out=100)), y=sin(seq(0, 2*pi, length.out=100))) +
    geom_segment(aes(x=0, xend = Dim.3, y=0, yend = Dim.4, colour = type), arrow=arrow(angle=20, length=unit(0.01, "npc"))) +
    scale_colour_manual(values = c("#225ea8","#3288bd")) + 
    geom_text_repel(aes(x=Dim.3, y=Dim.4, colour=type, label=var), 
            data=filter(pcad, (Dim.3^2+Dim.4^2) > 0.2^2), segment.alpha=0.5) +
    xlab(paste("PC3 ","(",pc3,"%)", sep="")) + ylab(paste("PC4 ","(",pc4,"%)", sep="")) + theme_bw()
    
### Map them
ddf$PC1 <- pca$ind$coord[,c(1)]
ddf$PC2 <- pca$ind$coord[,c(2)]
ddf$PC3 <- pca$ind$coord[,c(3)]
ddf$PC4 <- pca$ind$coord[,c(4)]

quartz()
ggplot() + geom_raster(aes(x = x, y = y, fill = PC1), data = ddf) +
	scale_fill_gradient2(name = paste("PC1 ","(",pc1,"%)", sep=""), mid = "white", high = "#d73027", low = "#4575b4") +
	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("180°W","120°W","60°W","0°E","60°E","120°E","180°E") ) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90), limits = c(-90,90), 
 		      labels = c("90°S","60°S","30°S","0°N","30°N","60°N","90°N") ) +
  	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
#
quartz()
ggplot() + geom_raster(aes(x = x, y = y, fill = PC2), data = ddf) +
	scale_fill_gradient2(name = paste("PC2 ","(",pc2,"%)", sep=""), mid = "white", high = "#d73027", low = "#4575b4") +
	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("180°W","120°W","60°W","0°E","60°E","120°E","180°E") ) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90), limits = c(-90,90), 
 		      labels = c("90°S","60°S","30°S","0°N","30°N","60°N","90°N") ) +
  	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
#
quartz()
ggplot() + geom_raster(aes(x = x, y = y, fill = PC3*-1), data = ddf) +
	scale_fill_gradient2(name = paste("PC3 ","(",pc3,"%)", sep=""), mid = "white", high = "#d73027", low = "#4575b4") +
	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("180°W","120°W","60°W","0°E","60°E","120°E","180°E") ) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90), limits = c(-90,90), 
 		      labels = c("90°S","60°S","30°S","0°N","30°N","60°N","90°N") ) +
  	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )
        
### ANd what if you map PC1*PC2?
quartz()
ggplot() + geom_raster(aes(x = x, y = y, fill = (PC1+PC2)), data = ddf) +
	scale_fill_gradient2(name = paste("PC3 ","(",pc3,"%)", sep=""), mid = "white", high = "#d73027", low = "#4575b4") +
	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("180°W","120°W","60°W","0°E","60°E","120°E","180°E") ) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90), limits = c(-90,90), 
 		      labels = c("90°S","60°S","30°S","0°N","30°N","60°N","90°N") ) +
  	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )

# OOOR, a sum weighted byt eh % of variance
ddf$sensitivity <- ((ddf$PC1)*(pc1*0.01)) + ((ddf$PC2)*(pc2*0.01)) + (((ddf$PC3)*-1)*(pc3*0.01))
summary(ddf$sensitivity)

quartz()
ggplot() + geom_raster(aes(x = x, y = y, fill = sensitivity), data = ddf) +
	scale_fill_gradient2(name = paste("Sensitivity", sep=""), mid = "white", high = "#d73027", low = "#4575b4") +
	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "grey70", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("180°W","120°W","60°W","0°E","60°E","120°E","180°E") ) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90), limits = c(-90,90), 
 		      labels = c("90°S","60°S","30°S","0°N","30°N","60°N","90°N") ) +
  	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
		panel.grid.major = element_line(colour = "grey70",linetype = "dashed") )

### Interpretation: 
# - PC1 > 0 --> increase in SRzoo and changes in composition ; < 0 --> decrease in SR zoo and weak TO
# - PC2: > 0 --> increase in SRphyto and changes in composition ; < 0 --> decrease in SR phyto and weak TO
# - PC3: > 0 --> decrease in SRzoo ; < 0 --> increase in SR zoo (hence the multiplication by -1)

### Cool, plot the synthetic index cross regions
#quartz()
plot1 <- ggplot(data = ddf, aes(y = abs(sensitivity), x = factor(pca_euclid_pam_k6) )) +
        geom_violin(colour = "black", fill = "grey65") + geom_boxplot(colour = "black", fill = "white", width = 0.125) + 
        geom_hline(yintercept = 0, linetype = "dashed", colour = "#d73027") + 
        scale_y_continuous(name = "Sensitivity of the\nplankton community") + 
        xlab("") + theme_classic()

### Re-map the klusters to have their distribb in mind
#cols <- c("1" = "#1a9850", "2" = "#a6d96a", "3" = "#fee08b", "4" = "#3288bd", "5" = "#abd9e9", "6" = "#d53e4f")
#quartz()
# mapA <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(pca_euclid_pam_k6)), data = ddf) +
#     scale_fill_brewer(name = "", palette = "RdYlBu") +
#      geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "#BAB0AC", colour = "black", size = 0.3) +
#      coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
#                labels = c("0°W","60°W","120°W","180°W","-120°W","-60°W","0°W"), expand = c(0,0)) +
#      scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90),
#                labels = c("-90°N","-60°N","-30°N","0°N","30°N","60°N","90°N"), expand = c(0,0)) +
#        theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
#          panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "right")
#
# ggsave(plot = mapA, filename = ".jpg", dpi = 300, )
        
# Draw some simple biplots between this synthetic index and ecisystem services globally
# quartz()
# ggplot() + geom_point(aes(x = sensitivity, y = OceanNorm), data = ddf) + theme_classic()
#
# quartz()
# ggplot() + geom_point(aes(x = sensitivity, y = small_catches), data = ddf) + theme_classic()
#
# quartz()
# ggplot() + geom_point(aes(x = sensitivity, y = log(NPP)), data = ddf) + theme_classic()
#
# quartz()
# ggplot() + geom_point(aes(x = sensitivity, y = log(FPOCex)), data = ddf) + theme_classic()
#
# quartz()
# ggplot() + geom_point(aes(x = sensitivity, y = e), data = ddf) + theme_classic()
#
# quartz()
# ggplot() + geom_point(aes(x = sensitivity, y = slope2), data = ddf) + theme_classic()

### Re-order clusters based on sensitivity: 
ddf$rank <- NA
for(k in unique(ddf$pca_euclid_pam_k6)) {
    ddf[which(ddf$pca_euclid_pam_k6 == 1),"rank"] <- 4
    ddf[which(ddf$pca_euclid_pam_k6 == 2),"rank"] <- 3
    ddf[which(ddf$pca_euclid_pam_k6 == 3),"rank"] <- 6
    ddf[which(ddf$pca_euclid_pam_k6 == 4),"rank"] <- 2
    ddf[which(ddf$pca_euclid_pam_k6 == 5),"rank"] <- 5
    ddf[which(ddf$pca_euclid_pam_k6 == 6),"rank"] <- 1
}
# Remap
cols <- c("4" = "#1a9850", "3" = "#a6d96a", "6" = "#fee08b", "2" = "#3288bd", "5" = "#abd9e9", "1" = "#d53e4f")
 
#quartz()
map_sensitivity <- ggplot() + geom_raster(aes(x = x, y = y, fill = factor(rank)), data = ddf) +
	#scale_fill_manual(name = "", values = cols) +
    scale_fill_brewer(name = "", palette = "RdYlBu") + 
 	geom_polygon(aes(x = long, y = lat, group = group), data = world2, fill = "#BAB0AC", colour = "black", size = 0.3) +
 	coord_quickmap() + scale_x_continuous(name = "", breaks = c(0,60,120,180,240,300,360),
               labels = c("180°W","120°W","60°W","0°E","60°E","120°E","180°E") ) +
 	scale_y_continuous(name = "", breaks = c(-90,-60,-30,0,30,60,90), limits = c(-90,90), 
 		      labels = c("90°S","60°S","30°S","0°N","30°N","60°N","90°N") ) +
   	theme(panel.background = element_rect(fill = "white"),legend.key = element_rect(fill = "grey50"),
 		panel.grid.major = element_line(colour = "grey70",linetype = "dashed"), legend.position = "right")

ggsave(plot = map_sensitivity, filename = "map_sensitivity.pdf", dpi = 300, height = 3, width = 6)

plot.severity <- ggplot(data = ddf, aes(y = abs(sensitivity), x = factor(rank), fill = factor(rank))) +
        geom_violin(colour = "black") + geom_boxplot(colour = "black", fill = "white", width = 0.125) + 
        scale_fill_brewer(name = "", palette = "RdYlBu", guide = F) +
        scale_y_continuous(name = "Severity of climate change impacts\non plankton community") + 
        xlab("") + theme_classic()

ggsave(plot = plot.severity, filename = "plot.severity.jpg", dpi = 300, height = 4, width = 6)

### And now, a panel plot with distrib of ecosystems properties: need to melt forst ;-)
colnames(ddf)
data2melt <- ddf[,c(16,18:20,22,24,30)]
head(data2melt)
colnames(data2melt)[c(1:6)] <- c("Oceanic species richness [13]","FPOC export [34]","NPP [34]",
                        "Export ratio (FPOC/NPP) [34]","Plankton size index [35]","Small pelagics catch rate [33]")
# Log transfrom NPP and POCexp
#data2melt[,"FPOC export"] <- log(data2melt[,"FPOC export"])
#data2melt$NPP <- log(data2melt$NPP)
melted <- melt(data2melt, id.vars = "rank")
head(melted)

### Re move some obs to better constrain the y axes:
levels(melted$variable)
# for NNP = c(3,7.2)
# for FPOC = c(1.95,5.5)
# melted <- melted[-which(melted[melted$variable == "NPP","value"] <= 0 | melted[melted$variable == "NPP","value"] >= 800),]
# melted <- melted[-which(melted[melted$variable == "FPOC export","value"] <= 0 | melted[melted$variable == "FPOC export","value"] >= 200),]
# melted <- melted[-which(melted[melted$variable == "Small pelagics catch rate","value"] <= 0 | melted[melted$variable == "Small pelagics catch rate","value"] >= 7),]

melted2 <- melted[melted[melted$variable == "NPP [34]","value"] < 800,]
melted3 <- melted2[melted2[melted2$variable == "Export ratio (FPOC/NPP) [34]","value"] < 250,]
melted4 <- melted3[melted3[melted3$variable == "Small pelagics catch rate [33]","value"] < 7.1,]
head(melted4)

#quartz()
distrib_es1 <- ggplot(aes(x = factor(rank), y = value, fill = factor(rank)), data = melted4) + geom_violin(colour = "black") + 
     geom_boxplot(colour = "black", fill = "white", width = 0.125) + scale_fill_brewer(name = "", palette = "RdYlBu") +
     xlab("Regions ranked by decreasing severity of climate change impacts on their plankton community") + 
     ylab("") + theme_bw() + facet_wrap(~ factor(variable), scale = "free_y")
#
#quartz()
distrib_es2 <- ggplot(aes(x = factor(rank), y = value, fill = factor(rank)), data = melted4) +
     geom_boxplot(colour = "black") + scale_fill_brewer(name = "", palette = "RdYlBu") +
     xlab("Regions ranked by decreasing severity of climate change impacts on their plankton community") + 
     ylab("") + theme_bw() + facet_wrap(~ factor(variable), scale = "free_y")
     
ggsave(plot = distrib_es1, filename = "distrib_es1.pdf", dpi = 300, height = 5, width = 10)
ggsave(plot = distrib_es2, filename = "distrib_es2.pdf", dpi = 300, height = 5, width = 10)


### Other possibility: per changes in diversity
colnames(ddf)
data2melt <- ddf[,c(4:8,30)]
colnames(data2melt)[c(1:5)] <- c("∆SRphyto","∆SRzoo","Overall changes in composition","Phytoplankton turn-over","Zooplankton turn-over")
melted <- melt(data2melt, id.vars = "rank")
head(melted)

#quartz()
distrib_pl1 <- ggplot(aes(x = factor(rank), y = value, fill = factor(rank)), data = melted) + geom_violin(colour = "black") + 
     geom_boxplot(colour = "black", fill = "white", width = 0.125) + scale_fill_brewer(name = "", palette = "RdYlBu") +
     xlab("Regions ranked by decreasing sensitivity of their plankton community to climate change") + 
     ylab("") + theme_bw() + facet_wrap(~ factor(variable), scale = "free_y")
#
#quartz()
distrib_pl2 <- ggplot(aes(x = factor(rank), y = value, fill = factor(rank)), data = melted) +
     geom_boxplot(colour = "black") + scale_fill_brewer(name = "", palette = "RdYlBu") +
     xlab("Regions ranked by decreasing sensitivity of their plankton community to climate change") + 
     ylab("") + theme_bw() + facet_wrap(~ factor(variable), scale = "free_y")

### Save plots
ggsave(plot = distrib_pl1, filename = "distrib_plankton_changes1.pdf", dpi = 300, height = 5, width = 10)
ggsave(plot = distrib_pl2, filename = "distrib_plankton_changes2.pdf", dpi = 300, height = 5, width = 10)




### 13/06/2020: Add another factor of facetting: per variable?
data <- get(load("table_ann_changes_diversity+services_ensemble_klusters_11_06_20.Rdata"))

require("FactoMineR")
require("ggrepel")
ncp <- 4
pca <- PCA(X = data[,c(4:8)], graph = F, scale.unit = T, ncp = ncp)
# Display summary
message(paste(summary(pca),sep = ""))
pc1 <- round(pca$eig[1,2],2); pc1
pc2 <- round(pca$eig[2,2],2); pc2
pc3 <- round(pca$eig[3,2],2); pc3
pc4 <- round(pca$eig[4,2],2); pc4
data$PC1 <- pca$ind$coord[,c(1)]
data$PC2 <- pca$ind$coord[,c(2)]
data$PC3 <- pca$ind$coord[,c(3)]
data$PC4 <- pca$ind$coord[,c(4)]
data$sensitivity <- ((data$PC1)*(pc1*0.01)) + ((data$PC2)*(pc2*0.01)) + (((data$PC3)*-1)*(pc3*0.01))
# summary(data$sensitivity)
data$rank <- NA
for(k in unique(data$pca_euclid_pam_k6)) {
    data[which(data$pca_euclid_pam_k6 == 1),"rank"] <- 4
    data[which(data$pca_euclid_pam_k6 == 2),"rank"] <- 3
    data[which(data$pca_euclid_pam_k6 == 3),"rank"] <- 6
    data[which(data$pca_euclid_pam_k6 == 4),"rank"] <- 2
    data[which(data$pca_euclid_pam_k6 == 5),"rank"] <- 5
    data[which(data$pca_euclid_pam_k6 == 6),"rank"] <- 1
}
# Remap
cols <- c("4" = "#1a9850", "3" = "#a6d96a", "6" = "#fee08b", "2" = "#3288bd", "5" = "#abd9e9", "1" = "#d53e4f")
 
### melt 
colnames(data)
data2melt <- data[,c(16,18:20,22,24,30)]
# head(data2melt)
colnames(data2melt)[c(1:6)] <- c("Oceanic species\nrichness [13]","FPOC export\n[34]","NPP [34]",
                        "BCP efficiency\n(FPOC/NPP) [34]","Plankton size\n[35]","Small pelagics\ncatch rate [33]")

melted <- melt(data2melt, id.vars = "rank")
head(melted)
melted2 <- melted[melted[melted$variable == "NPP [34]","value"] < 800,]
melted3 <- melted2[melted2[melted2$variable == "FPOC export\n[34]","value"] < 250,]
melted4 <- melted3[melted3[melted3$variable == "Small pelagics\ncatch rate [33]","value"] < 7.1,]
head(melted4)

quartz()
ggplot(aes(x = factor(rank), y = value, fill = factor(rank)), data = melted4) + geom_violin(colour = "black") + 
     geom_boxplot(colour = "black", fill = "white", width = 0.125) + scale_fill_brewer(name = "", palette = "RdYlBu") +
     xlab("Regions ranked by decreasing sensitivity of their plankton community to climate change") + 
     ylab("") + theme_bw() + facet_wrap(factor(variable) ~factor(rank), scale = "free")
#
quartz()
ggplot(aes(x = factor(rank), y = value, fill = factor(rank)), data = melted4) + 
     geom_boxplot(colour = "black") + scale_fill_brewer(name = "", palette = "RdYlBu") +
     xlab("Regions ranked by decreasing sensitivity of their plankton community to climate change") + 
     ylab("") + theme_bw() + facet_wrap(factor(variable) ~ factor(rank), scale = "free")

### 22/06/2020: Re-plot severity
plot.severity <- ggplot(data = data, aes(y = abs(sensitivity), x = factor(rank), fill = factor(rank))) +
    geom_violin(colour = "black") + geom_boxplot(colour = "black", fill = "white", width = 0.125) + 
    scale_fill_brewer(name = "", palette = "RdYlBu", guide = F) +
    scale_y_continuous(name = "Severity of climate change impacts on plankton community", position = "top") + 
    xlab("") + theme_classic()
#
ggsave(plot = plot.severity, filename = "plot_severity.pdf", dpi = 300, height = 8, width = 7)



# --------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------------------------------------------------


